---
phase: 04-code-quality
plan: 05
type: execute
depends_on: ["04-04"]
files_modified: [js/config/hazards.js, js/modules/riskCalculator.js, js/modules/msdsParser.js, coshhgeneratorv5.html]
---

<objective>
Add explanatory comments to complex business logic, document assumptions, and clarify non-obvious code patterns.

Purpose: Make the codebase easier for new developers to understand by documenting the "why" behind complex logic, COSHH-specific algorithms, and edge cases.
Output: Comprehensive inline comments explaining hazard mapping logic, risk calculation methodology, MSDS parsing patterns, and key assumptions.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-code-quality/04-04-SUMMARY.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/CONCERNS.md

**Tech stack available:**
- JSDoc for function-level documentation (completed in Phase 3)
- Inline comments for logic explanation

**Established patterns:**
- JSDoc already added to exported functions (Phase 3)
- Focus on public API documentation

**Current concerns from CONVENTIONS.md:**
- JSDoc comments not consistently used (improved in Phase 3)
- Minimal inline comments explaining complex logic
- TODO comments scattered without tracking

**Current concerns from CONCERNS.md:**
- Complex hazard mapping logic not well documented
- Risk calculation thresholds lack rationale
- MSDS parsing patterns unclear to new developers
- Edge cases not documented

**Fragile areas from CONCERNS.md:**
- H-phrase to hazard group mapping (js/config/hazards.js)
- Risk calculation thresholds (coshhgeneratorv5.html)
- MSDS confidence scoring logic (msdsParser.js)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document complex business logic and algorithms</name>
  <files>js/config/hazards.js, js/modules/riskCalculator.js, coshhgeneratorv5.html</files>
  <action>
Add explanatory comments to complex business logic:

**Hazard Mapping (js/config/hazards.js):**
Add file-level comment explaining the system:
```javascript
/**
 * H-phrase to Hazard Group mapping for COSHH Control Banding
 *
 * Based on HSE COSHH Essentials methodology (https://www.hse.gov.uk/coshh/essentials/)
 * Each H-phrase is mapped to a hazard group (A-E) which determines the control approach:
 *
 * Group A: Special (carcinogens, mutagens, asthmagens) - requires specific controls
 * Group B: High hazard - extensive controls needed
 * Group C: Moderate hazard - engineering controls recommended
 * Group D: Low hazard - good general ventilation usually sufficient
 * Group E: Very low hazard - minimal controls needed
 *
 * Unmapped H-phrases default to Group C (moderate) to avoid under-protecting.
 */
```

Add comments for non-obvious mappings:
```javascript
hPhraseToHazardGroup = {
    // Carcinogens, mutagens, reproductive toxins → Group A (special controls)
    'H340': 'A', // May cause genetic defects
    'H350': 'A', // May cause cancer
    'H360': 'A', // May damage fertility or unborn child

    // Respiratory sensitizers → Group A (asthma risk)
    'H334': 'A', // May cause allergy or asthma symptoms

    // Acute toxicity → Group B (high hazard)
    'H300': 'B', // Fatal if swallowed
    'H310': 'B', // Fatal in contact with skin

    // ... etc with rationale for each grouping
}
```

**Risk Calculator (js/modules/riskCalculator.js):**
Add comments explaining the algorithm:
```javascript
/**
 * Calculate overall likelihood score based on COSHH Essentials factors
 *
 * Algorithm combines:
 * 1. Quantity used (small amounts = lower likelihood)
 * 2. Volatility/dustiness (physical form affects exposure)
 * 3. Procedure (intrinsic exposure potential)
 * 4. Frequency (how often the task is done)
 * 5. Duration (how long exposure lasts)
 *
 * Score ranges from 1 (lowest) to 5 (highest).
 * Conservative approach: when uncertain, assume higher exposure.
 */
```

Add threshold rationale:
```javascript
// Risk matrix thresholds based on HSE COSHH Essentials
// Severity 1-2 + Likelihood 1-2 → Low risk (green)
// Severity 3-4 + Likelihood 3-4 → Medium risk (amber)
// Severity 4-5 + Likelihood 4-5 → High risk (red)
// These thresholds align with standard risk assessment practices
if (severity >= 4 && likelihood >= 4) {
    return 'high'; // Immediate action required
}
```

**Control Band Determination (coshhgeneratorv5.html):**
Document the control banding logic:
```javascript
/**
 * COSHH Control Banding Algorithm
 *
 * Determines appropriate control approach based on:
 * - Hazard group (A-E) from H-phrase mapping
 * - Exposure potential (likelihood score)
 *
 * Control bands (1-4):
 * 1 = General ventilation (low hazard, low exposure)
 * 2 = Engineering controls (moderate hazard or exposure)
 * 3 = Containment (high hazard or high exposure)
 * 4 = Seek specialist advice (Group A hazards, very high exposure)
 *
 * Source: HSE COSHH Essentials control approach sheets
 */
```

Why: This logic is critical for safety but non-obvious to developers unfamiliar with COSHH methodology. Comments provide context and link to authoritative sources.
  </action>
  <verify>
Code review checklist:
- [ ] Hazard mapping has file-level explanation of the system
- [ ] Non-obvious H-phrase groupings have rationale comments
- [ ] Risk calculation algorithm is explained step-by-step
- [ ] Risk thresholds include rationale and source
- [ ] Control banding logic is documented with methodology
- [ ] Comments explain "why" not just "what"
- [ ] HSE COSHH Essentials referenced as authoritative source
  </verify>
  <done>
- js/config/hazards.js has comprehensive file comment explaining hazard groups
- H-phrase mappings include rationale for non-obvious groupings
- Risk calculator has algorithm explanation and threshold rationale
- Control banding logic documented with methodology reference
- All complex business logic includes "why" explanations
- HSE COSHH Essentials cited as authoritative source
  </done>
</task>

<task type="auto">
  <name>Task 2: Document assumptions, edge cases, and non-obvious patterns</name>
  <files>js/modules/msdsParser.js, js/modules/riskCalculator.js, coshhgeneratorv5.html</files>
  <action>
Add comments documenting assumptions and edge cases:

**MSDS Parser (js/modules/msdsParser.js):**
Document parsing assumptions:
```javascript
/**
 * MSDS Parsing Assumptions:
 *
 * 1. Section numbering: Assumes GHS 16-section format (Section 3 = Composition)
 * 2. H-phrases: Expects format "H###" or "H###-###" (e.g., "H302", "H302-312")
 * 3. CAS numbers: Expects format "XXXXX-XX-X" or "XXX-XX-X"
 * 4. Signal words: Only recognizes "Danger" and "Warning" (case-insensitive)
 *
 * Non-standard MSDS formats may result in incomplete extraction.
 * Users can manually edit extracted data in preview table.
 */
```

Document confidence scoring:
```javascript
// Confidence scoring (high/medium/low) based on extraction robustness:
// HIGH: Found in standard location with clear formatting
// MEDIUM: Found but format non-standard or ambiguous
// LOW: Extracted from fallback patterns, likely needs review
//
// Example: H-phrases in Section 2 with "H302 H315" → HIGH confidence
// Example: H-phrases scattered in text without section header → LOW confidence
```

Document known edge cases:
```javascript
// Edge case: Multi-component products list multiple CAS numbers
// Strategy: Extract first CAS as primary, store others in notes field
// User should review and select appropriate CAS if needed

// Edge case: Some MSDS use obsolete R-phrases instead of H-phrases
// Current limitation: Not converted to H-phrases automatically
// User must manually translate or use H-phrase reference
```

**Risk Calculator edge cases:**
```javascript
// Edge case: Empty H-phrases array
// Behavior: Falls back to signal word severity only
// Rationale: Signal word provides baseline hazard level

// Edge case: Null procedureData (procedure not selected)
// Behavior: Uses default base score of 1.5
// Rationale: Conservative estimate for unknown procedure exposure

// Edge case: Zero quantity
// Behavior: Returns minimum likelihood (1)
// Rationale: No chemical used = minimal exposure potential
```

**Form handling edge cases (coshhgeneratorv5.html):**
```javascript
// Edge case: LocalStorage quota exceeded (typically 5-10MB)
// Current behavior: Silent failure (localStorage.setItem throws)
// TODO: Add try/catch, prompt user to export to JSON if quota exceeded
// See CONCERNS.md "LocalStorage quota exceeded not handled"

// Edge case: Multiple checkboxes with same name (e.g., whoExposed)
// Behavior: FormData collects as array, saved correctly to localStorage
// Import must handle both array and single values for compatibility
```

Clean up existing TODO comments:
- Review existing `// TODO:` comments in code
- If addressed in Phase 1-4: Remove TODO, add explanation comment
- If still relevant: Keep TODO with context and priority
- If future enhancement: Move to .planning/ISSUES.md as ISS-XXX

Why: Documenting assumptions and edge cases prevents future developers from breaking behavior or wondering why code works a certain way. Edge case documentation prevents bugs from "fixes" that don't understand the full context.
  </action>
  <verify>
Code review checklist:
- [ ] MSDS parser has assumptions documented at file level
- [ ] Confidence scoring logic is explained
- [ ] Known edge cases documented with behavior and rationale
- [ ] Risk calculator edge cases explained
- [ ] Form handling edge cases documented
- [ ] Existing TODO comments reviewed and cleaned up
- [ ] Remaining TODOs have context and priority
- [ ] Comments explain non-obvious design decisions
  </verify>
  <done>
- MSDS parser assumptions documented at file level
- Confidence scoring logic explained with examples
- Edge cases documented: multi-component products, obsolete R-phrases, empty arrays
- Risk calculator edge cases explained with rationale
- Form handling edge cases documented with TODOs for future fixes
- Existing TODO comments reviewed: [N] removed, [M] kept with context
- All non-obvious patterns have explanatory comments
- Future developers have context for understanding design decisions
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm test passes (no breaking changes from comments)
- [ ] Code review: Read through commented files, verify clarity
- [ ] New developer perspective: Would comments help someone unfamiliar with COSHH?
- [ ] All fragile areas from CONCERNS.md have explanatory comments
- [ ] Edge cases documented with behavior and rationale
- [ ] No misleading or outdated comments
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Complex business logic (hazard mapping, risk calculation, control banding) fully documented
- MSDS parsing assumptions and patterns explained
- Edge cases documented with rationale
- Code is significantly easier to understand for new developers
- Comments explain "why" not just "what"
- Phase 4 complete: Code quality dramatically improved
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-05-SUMMARY.md`:

# Phase 4 Plan 5: Explanatory Comments Summary

**Added comprehensive inline comments documenting COSHH methodology, assumptions, and edge cases across 4 modules**

## Accomplishments

- Documented hazard group mapping with HSE COSHH Essentials methodology
- Explained risk calculation algorithm with threshold rationale
- Added MSDS parsing assumptions and confidence scoring logic
- Documented 10+ edge cases with behavior and rationale
- Cleaned up existing TODO comments
- Linked to authoritative sources (HSE guidance)

## Files Created/Modified

- `js/config/hazards.js` - File-level methodology comment, H-phrase rationale
- `js/modules/riskCalculator.js` - Algorithm explanation, edge case documentation
- `js/modules/msdsParser.js` - Assumptions, confidence scoring, edge cases
- `coshhgeneratorv5.html` - Control banding logic, form handling edge cases

## Decisions Made

[Comment style, level of detail, TODO cleanup approach]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

**Phase 4 Complete: Code Quality ✓**

Ready for Phase 5: User Role Simulation

**Code Quality Improvements Achieved:**
- ✅ JavaScript extracted to modules (04-01)
- ✅ Code formatting standardized with Prettier/ESLint (04-02)
- ✅ Long functions refactored into focused units (04-03)
- ✅ Error messages and logging enhanced (04-04)
- ✅ Complex logic fully documented (04-05)

**Benefits Delivered:**
- coshhgeneratorv5.html reduced from 1579 to ~1220 lines
- Code is modular, testable, and maintainable
- Error messages guide users to solutions
- Debug logging aids troubleshooting
- New developers can understand COSHH methodology from code comments
- Ready to build user roles and approval workflows

---
*Phase: 04-code-quality*
*Completed: [date]*
</output>
