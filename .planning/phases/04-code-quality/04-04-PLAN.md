---
phase: 04-code-quality
plan: 04
type: execute
depends_on: ["04-03"]
files_modified: [js/modules/logger.js, js/modules/msdsParser.js, js/modules/domHelpers.js, js/eh40-loader.js, coshhgeneratorv5.html]
---

<objective>
Add structured logging infrastructure and improve error messages throughout the application for better debugging and user experience.

Purpose: Replace console.log with structured logging, improve user-facing error messages with actionable guidance, add debug logging to critical paths for troubleshooting.
Output: Logger module with log levels, improved error messages, debug logging in MSDS parsing and data loading, better user experience during errors.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-code-quality/04-03-SUMMARY.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/CONCERNS.md

**Tech stack available:**
- ES6 modules
- Browser console API
- Existing error handling in Phase 2 (retry logic, error messages)

**Established patterns:**
- ES6 modules with named exports and window exposure
- JSDoc documentation
- Error handling with user-facing messages

**Current concerns from CONVENTIONS.md:**
- Only console.log() for logging - no structured logging
- No log levels (debug, info, warn, error)
- User-facing messages via DOM updates

**Current concerns from CONCERNS.md:**
- Generic error messages don't guide users to solutions
- No structured logging for debugging production issues
- Hard to troubleshoot issues without debug logs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create structured logging module</name>
  <files>js/modules/logger.js, package.json</files>
  <action>
Create js/modules/logger.js with log level support:

```javascript
/**
 * @fileoverview Structured logging with log levels and formatting
 * @module logger
 */

const LOG_LEVELS = {
    DEBUG: 0,
    INFO: 1,
    WARN: 2,
    ERROR: 3,
};

let currentLogLevel = LOG_LEVELS.INFO; // Default to INFO in production

/**
 * Set the minimum log level
 * @param {string} level - 'DEBUG', 'INFO', 'WARN', or 'ERROR'
 */
function setLogLevel(level) {
    currentLogLevel = LOG_LEVELS[level] || LOG_LEVELS.INFO;
}

/**
 * Debug-level logging (detailed diagnostic info)
 * @param {string} message - Log message
 * @param {*} data - Optional data to log
 */
function debug(message, data) {
    if (currentLogLevel <= LOG_LEVELS.DEBUG) {
        console.log(`[DEBUG] ${message}`, data !== undefined ? data : '');
    }
}

/**
 * Info-level logging (general informational messages)
 * @param {string} message - Log message
 * @param {*} data - Optional data to log
 */
function info(message, data) {
    if (currentLogLevel <= LOG_LEVELS.INFO) {
        console.log(`[INFO] ${message}`, data !== undefined ? data : '');
    }
}

/**
 * Warning-level logging (potential issues)
 * @param {string} message - Log message
 * @param {*} data - Optional data to log
 */
function warn(message, data) {
    if (currentLogLevel <= LOG_LEVELS.WARN) {
        console.warn(`[WARN] ${message}`, data !== undefined ? data : '');
    }
}

/**
 * Error-level logging (serious problems)
 * @param {string} message - Log message
 * @param {Error|*} error - Error object or data
 */
function error(message, error) {
    if (currentLogLevel <= LOG_LEVELS.ERROR) {
        console.error(`[ERROR] ${message}`, error || '');
    }
}

export { setLogLevel, debug, info, warn, error };

// Expose globally for non-module scripts
window.logger = { setLogLevel, debug, info, warn, error };
```

Add script tag to coshhgeneratorv5.html:
```html
<script type="module" src="js/modules/logger.js"></script>
```

Why: Structured logging with levels allows developers to enable debug logs when troubleshooting without cluttering production console. Prefixes make logs searchable.
  </action>
  <verify>
Open browser console and test:
```javascript
logger.setLogLevel('DEBUG');
logger.debug('Test debug message', {test: 'data'});
logger.info('Test info message');
logger.warn('Test warning');
logger.error('Test error', new Error('Test error object'));

logger.setLogLevel('WARN');
logger.debug('Should not appear');
logger.info('Should not appear');
logger.warn('Should appear');
```
Verify log levels filter correctly and messages are formatted with prefixes.
  </verify>
  <done>
- js/modules/logger.js exists with setLogLevel, debug, info, warn, error functions
- All functions have JSDoc documentation
- Logger exposed via window.logger
- Script tag added to HTML
- Manual testing confirms log level filtering works
  </done>
</task>

<task type="auto">
  <name>Task 2: Improve user-facing error messages</name>
  <files>js/modules/msdsParser.js, js/eh40-loader.js, js/modules/domHelpers.js</files>
  <action>
Review and improve error messages to be actionable and user-friendly:

**MSDS Parser (js/modules/msdsParser.js):**
- OLD: "Error parsing PDF"
- NEW: "Could not parse PDF file. Please try: (1) Check the file isn't corrupted, (2) Try pasting MSDS text instead, (3) Manually enter hazard information in Step 3"

- OLD: "Parsing failed"
- NEW: "MSDS parsing incomplete. Extracted [N] fields successfully. Please review and manually complete missing information."

**EH40 Loader (js/eh40-loader.js):**
- OLD: "Failed to load EH40 data"
- NEW: "Could not load workplace exposure limits (WEL) data. You can continue without WEL auto-fill or reload the page to retry. [Retry Button]"

- OLD: "Network error"
- NEW: "Network connection issue while loading data. Click Retry or check your internet connection. [Retry Button]"

**DOM Helpers (js/modules/domHelpers.js):**
- Errors already have [DOM] prefix from Phase 2
- Improve messages to mention element ID:
  - OLD: "[DOM] Element not found"
  - NEW: "[DOM] Could not find form element with ID '{elementId}'. This is likely a bug - please report it."

Pattern for good error messages:
1. What went wrong (clear, non-technical)
2. Why it might have happened (if known)
3. What user can do (actionable steps)
4. Offer recovery option (retry button, alternative approach)

Update error display divs (parserStatus, inventoryStatus) to use better styling:
- Add CSS classes: .error-message, .warning-message, .success-message
- Include icon/emoji: ❌ for errors, ⚠️ for warnings, ✅ for success

Why: Generic errors frustrate users. Actionable messages with recovery options turn failures into guided experiences.
  </action>
  <verify>
Test error scenarios:
1. Upload corrupted PDF - verify improved error message with alternatives
2. Disconnect network, try loading EH40 - verify helpful network error
3. Check browser console - verify technical details still logged for developers

Verify error messages:
- Are clear and non-technical
- Suggest concrete actions
- Offer recovery options where possible
- Include emoji/icons for visual clarity
  </verify>
  <done>
- MSDS parser has improved error messages with alternatives
- EH40 loader has helpful network error messages with retry
- DOM helpers mention element IDs in errors
- Error messages follow pattern: what, why, what to do
- CSS classes added for error/warning/success styling
- All error scenarios show improved messages
  </done>
</task>

<task type="auto">
  <name>Task 3: Add debug logging to critical paths</name>
  <files>js/modules/msdsParser.js, js/modules/riskCalculator.js, js/eh40-loader.js</files>
  <action>
Import logger in each module:
```javascript
import { debug, info, warn, error } from './logger.js';
```

Add debug logging to critical operations:

**MSDS Parser (js/modules/msdsParser.js):**
```javascript
debug('Starting PDF parse', { fileSize: file.size, fileName: file.name });
debug('PDF text extraction complete', { pageCount, textLength });
debug('Extracted H-phrases', { hPhrases });
debug('Confidence scoring complete', { overallConfidence });
info('MSDS parsing successful', { fieldsExtracted: Object.keys(extractedData).length });
```

**Risk Calculator (js/modules/riskCalculator.js):**
```javascript
debug('Calculating severity', { hPhrases, signalWord });
debug('Severity calculation complete', { severity, dominantHazard });
debug('Calculating likelihood', { quantity, unit, frequency, duration });
debug('Likelihood calculation complete', { likelihood, procedure });
info('Risk assessment complete', { severity, likelihood, riskLevel });
```

**EH40 Loader (js/eh40-loader.js):**
```javascript
debug('Starting EH40 data fetch', { url });
debug('EH40 fetch complete', { recordCount });
info('WEL data loaded successfully', { chemicals: data.length });
warn('EH40 fetch retry attempt', { attempt, delayMs });
error('EH40 loading failed after retries', { attempts: 3 });
```

Enable debug logs during development:
- Add to HTML: `<script>logger.setLogLevel('DEBUG');</script>` (commented out by default)
- Document in CONTRIBUTING.md: "Enable debug logs with `logger.setLogLevel('DEBUG')` in browser console"

Why: Debug logs make troubleshooting much easier without adding complexity to production. Developers can enable them on-demand when investigating issues.
  </action>
  <verify>
Open browser console:
```javascript
logger.setLogLevel('DEBUG');
```
Then test:
1. Parse an MSDS PDF - verify debug logs show parsing steps
2. Complete risk assessment - verify debug logs show calculations
3. Load EH40 data - verify debug logs show fetch progress

Verify:
- Debug logs provide useful diagnostic information
- Logs don't overwhelm console (reasonable quantity)
- Log data includes relevant context (file sizes, counts, values)
- Production mode (INFO level) shows only important events
  </verify>
  <done>
- Logger imported in msdsParser, riskCalculator, eh40-loader modules
- Debug logging added to MSDS parsing steps
- Debug logging added to risk calculation steps
- Debug logging added to data loading operations
- Info/warn/error logs added at key milestones
- Debug logs provide actionable diagnostic information
- Production console remains clean (INFO level default)
- CONTRIBUTING.md updated with debug logging instructions
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm test passes (no breaking changes)
- [ ] Logger module works with all log levels
- [ ] User-facing error messages are helpful and actionable
- [ ] Debug logs can be enabled and provide useful information
- [ ] Production console is clean (INFO level or higher only)
- [ ] Error styling is visually clear (icons, colors)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Logger module created with 4 log levels
- User-facing error messages improved in 3+ modules
- Debug logging added to MSDS parsing, risk calculation, data loading
- Better debugging experience for developers
- Better error experience for users
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-04-SUMMARY.md`:

# Phase 4 Plan 4: Error Messages & Logging Summary

**Added structured logging with 4 levels, improved error messages in 3 modules, added debug logging to critical paths**

## Accomplishments

- Created logger.js module with DEBUG, INFO, WARN, ERROR levels
- Improved user-facing error messages with actionable guidance
- Added debug logging to MSDS parsing, risk calculation, EH40 loading
- Enhanced error display styling with icons and CSS classes
- Documented debug logging in CONTRIBUTING.md

## Files Created/Modified

- `js/modules/logger.js` - NEW: Structured logging module
- `js/modules/msdsParser.js` - Improved error messages, added debug logging
- `js/modules/riskCalculator.js` - Added debug logging
- `js/eh40-loader.js` - Improved error messages, added debug logging
- `js/modules/domHelpers.js` - Enhanced error messages with element IDs
- `coshhgeneratorv5.html` - Added logger script tag
- `CONTRIBUTING.md` - Documented debug logging usage

## Decisions Made

[Log level defaults, error message patterns, debug log placement strategy]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 04-05-PLAN.md - Explanatory Comments
</output>
