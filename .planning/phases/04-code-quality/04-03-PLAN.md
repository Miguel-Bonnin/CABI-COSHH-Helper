---
phase: 04-code-quality
plan: 03
type: execute
depends_on: ["04-02"]
files_modified: [coshhgeneratorv5.html, js/modules/reportGenerator.js]
---

<objective>
Refactor long, complex functions in coshhgeneratorv5.html into smaller, focused functions for better clarity and maintainability.

Purpose: Break down monolithic functions (100+ lines) into logical steps that are easier to understand, debug, and modify.
Output: Risk assessment and report generation logic refactored into smaller functions (~20-30 lines each), code is more readable and maintainable.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-code-quality/04-02-SUMMARY.md
@.planning/codebase/CONCERNS.md
@coshhgeneratorv5.html

**Tech stack available:**
- ES6 modules with named exports
- Prettier and ESLint for formatting
- JSDoc for documentation

**Established patterns:**
- Pure functions for calculations (from Phase 1)
- Module extraction with window exports (from 04-01)
- JSDoc comments for exported functions (from Phase 3)

**Current concerns from CONCERNS.md:**
- Monolithic functions 100+ lines
- Risk assessment logic spread across multiple long functions
- Report generation is one large function
- Difficult to understand flow and debug issues

**Concerns from CONVENTIONS.md:**
- Function sizes vary widely - some 5-10 lines, others 100+ lines
- coshhgeneratorv5.html contains very long inline script section
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor risk assessment logic into focused functions</name>
  <files>coshhgeneratorv5.html</files>
  <action>
Identify long risk assessment functions in coshhgeneratorv5.html (likely in inline <script> section after line 629):
- runFullRiskAssessmentLogic() - main risk calculation orchestrator
- Any functions handling control band determination
- Functions calculating risk levels and updating UI

Refactor by extracting logical steps:
1. **Separate data collection from calculation:**
   - extractFormData() - gets values from DOM
   - calculateRisk(formData) - pure calculation (call existing riskCalculator module)

2. **Separate calculation from UI updates:**
   - updateRiskMatrixDisplay(riskData) - updates DOM with risk level
   - updateSuitableControlsDisplay(controlBand) - updates control recommendations

3. **Break down control band logic:**
   - determineControlBand(hazardGroup, likelihood, exposureLevel) - business logic
   - Apply control band determination algorithm step by step

Each extracted function:
- ~20-30 lines maximum
- Single responsibility (does one thing)
- Descriptive name indicating what it does
- Add JSDoc comment explaining purpose

Keep in inline script for now (will be extracted to module in future phase). Focus on clarity over modularity.

Why: Breaking 100+ line functions into focused 20-30 line functions makes logic easier to follow. Each step has a clear purpose and can be understood independently.
  </action>
  <verify>
Open coshhgeneratorv5.html in browser:
1. Fill out hazard information (H-phrases, signal word)
2. Select procedure and fill quantity/frequency
3. Verify risk assessment calculations run
4. Check risk matrix displays correct risk level
5. Verify suitable controls section updates
6. Check browser console - no errors
Manual code review:
- Verify no function >50 lines in risk assessment section
- Check that logic flow is clearer and easier to follow
  </verify>
  <done>
- Risk assessment logic refactored into 5-7 focused functions
- Each function <50 lines, most ~20-30 lines
- Function names clearly indicate purpose
- JSDoc comments added to major functions
- All risk assessment functionality works identically
- No console errors during risk assessment
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract and refactor report generation logic</name>
  <files>js/modules/reportGenerator.js, coshhgeneratorv5.html</files>
  <action>
Create js/modules/reportGenerator.js and extract report generation logic from coshhgeneratorv5.html:
- generateFullReport() - main report orchestrator
- Related helper functions for sections

Refactor during extraction:
1. **Break generateFullReport into section builders:**
   - buildReportHeader(formData) - title, ref, date
   - buildSubstanceSection(formData) - chemical name, CAS, description
   - buildHazardsSection(formData) - H-phrases, signal word, hazard groups
   - buildRiskAssessmentSection(riskData) - likelihood, severity, matrix
   - buildControlsSection(formData) - existing and additional controls
   - buildApprovalSection(formData) - signatures, dates

2. **Each section builder:**
   - Returns HTML string for that section
   - ~20-40 lines each
   - Takes only data it needs (not entire form)
   - JSDoc with @param and @returns

3. **Main generateFullReport function:**
   - Orchestrates section builders
   - Assembles final HTML
   - ~30-40 lines total
   - Much easier to understand than monolithic version

Add to HTML:
- <script type="module" src="js/modules/reportGenerator.js"></script>
- Export via window.reportGenerator for onclick compatibility
- Remove old generateFullReport from inline script

Why: Report generation is currently one massive function (likely 200+ lines). Breaking into sections makes it maintainable - each section can be modified independently.
  </action>
  <verify>
Open coshhgeneratorv5.html in browser:
1. Fill out a complete COSHH assessment
2. Go to Report tab
3. Click "Generate Report" button
4. Verify report displays all sections correctly
5. Print preview - verify layout is correct
6. Check browser console - no errors

Manual code review:
- Verify js/modules/reportGenerator.js has section builder functions
- Check that each section builder is <50 lines
- Verify main generateFullReport is ~30-40 lines
  </verify>
  <done>
- js/modules/reportGenerator.js created with refactored report generation
- generateFullReport broken into 6 section builder functions
- Each function ~20-40 lines, single responsibility
- Main generateFullReport orchestrates sections (~30-40 lines)
- JSDoc added to all exported functions
- Report generation works identically
- All sections render correctly
- Print layout unchanged
- No console errors during report generation
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm test passes (no breaking changes)
- [ ] Manual testing: Complete COSHH assessment end-to-end, verify all features
- [ ] Risk assessment calculates correctly
- [ ] Report generates with all sections
- [ ] No functions >50 lines in refactored code
- [ ] Code is noticeably easier to read and understand
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Risk assessment logic refactored into 5-7 focused functions
- Report generation extracted to reportGenerator.js with 6 section builders
- No functions >50 lines in refactored areas
- All functionality preserved, no breaking changes
- Code is significantly more maintainable
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-03-SUMMARY.md`:

# Phase 4 Plan 3: Function Refactoring Summary

**Refactored risk assessment and report generation into 12+ focused functions, improving code clarity**

## Accomplishments

- Refactored risk assessment logic into 5-7 focused functions (<50 lines each)
- Extracted report generation to reportGenerator.js module
- Broke generateFullReport into 6 section builder functions
- Reduced longest functions from 100+ lines to <50 lines
- Added JSDoc to all refactored functions

## Files Created/Modified

- `js/modules/reportGenerator.js` - NEW: Modular report generation
- `coshhgeneratorv5.html` - Refactored risk assessment functions

## Decisions Made

[How functions were split, naming conventions for section builders, any edge cases]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 04-04-PLAN.md - Enhanced Error Messages & Logging
</output>
