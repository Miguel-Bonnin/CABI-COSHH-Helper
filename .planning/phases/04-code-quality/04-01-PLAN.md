---
phase: 04-code-quality
plan: 01
type: execute
depends_on: []
files_modified: [js/modules/formManager.js, js/modules/msdsParser.js, coshhgeneratorv5.html]
---

<objective>
Extract inline JavaScript from coshhgeneratorv5.html into dedicated modules for better maintainability and testability.

Purpose: Reduce the 1579-line monolithic HTML file by moving form handling and MSDS parsing logic to separate modules, making code easier to navigate, test, and modify.
Output: Two new modules (formManager.js, msdsParser.js) with extracted logic, HTML file reduced by ~400 lines, all existing functionality preserved.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-documentation-excellence/03-05-SUMMARY.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/CONCERNS.md
@coshhgeneratorv5.html

**Tech stack available:**
- ES6 modules ("type": "module")
- Vitest for testing
- Pure function design for calculations
- Module pattern with named exports

**Established patterns:**
- Files use kebab-case naming
- Functions use camelCase
- Modules export to window for global access (during transition)
- JSDoc comments for exported functions

**Constraining decisions:**
- Maintain backward compatibility during extraction (HTML still works)
- Use ES6 module syntax for new modules
- Add JSDoc to exported functions
- No breaking changes to existing functionality

**Current concerns from CONCERNS.md:**
- 1579-line HTML file with embedded JavaScript (lines 629+)
- Functions mixed with HTML making navigation difficult
- Hard to test inline functions
- Target: Extract ~400 lines to modules
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract form handling functions to formManager.js</name>
  <files>js/modules/formManager.js, coshhgeneratorv5.html</files>
  <action>
Create js/modules/formManager.js and extract these functions from coshhgeneratorv5.html:
- saveLocally() - saves form data to localStorage
- loadLocally() - loads form data from localStorage
- exportToJson() - exports form as downloadable JSON
- importFromJsonFile() - imports JSON file to populate form

Add JSDoc comments to each function with @param, @returns, @throws tags.
Use ES6 export syntax: export { saveLocally, loadLocally, exportToJson, importFromJsonFile }
Also export to window for backward compatibility: window.formManager = { saveLocally, loadLocally, exportToJson, importFromJsonFile }

Update coshhgeneratorv5.html:
- Add <script type="module" src="js/modules/formManager.js"></script> to head
- Remove the extracted function definitions from inline <script> section
- Button onclick handlers still work via window.formManager.functionName

Why: Extracting these ~150 lines makes form logic testable and easier to maintain. Window export maintains compatibility with existing onclick handlers.
  </action>
  <verify>
Open coshhgeneratorv5.html in browser:
1. Click "Save Locally" button - should save to localStorage without errors
2. Click "Load Locally" button - should restore saved data
3. Click "Export to JSON" button - should download JSON file
4. Import a JSON file - should populate form fields
5. Check browser console - no errors
6. Verify HTML file is ~150 lines shorter
  </verify>
  <done>
- js/modules/formManager.js exists with 4 exported functions and JSDoc
- coshhgeneratorv5.html reduced by ~150 lines
- All form save/load/export/import functionality works identically
- No console errors when using form features
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract MSDS parsing logic to msdsParser.js</name>
  <files>js/modules/msdsParser.js, coshhgeneratorv5.html</files>
  <action>
Create js/modules/msdsParser.js and extract MSDS parsing functions from coshhgeneratorv5.html:
- parseUploadedMSDS() - parses PDF using PDF.js
- parseTextPaste() - parses pasted text
- applyParsedDataToForm() - applies parsed data to form fields
- Related helper functions for data extraction and confidence scoring

Add JSDoc with @param, @returns, @throws tags for exported functions.
Export main functions and expose via window.msdsParser for onclick compatibility.

Update coshhgeneratorv5.html:
- Add <script type="module" src="js/modules/msdsParser.js"></script>
- Remove extracted parsing logic (~200-250 lines)
- Update button onclick handlers to use window.msdsParser methods

Handle PDF.js dependency:
- Import PDF.js at top of msdsParser.js if needed
- Ensure pdfjsLib is available from CDN script

Why: MSDS parsing is complex business logic (~250 lines) that belongs in a dedicated module. Separating it makes the code easier to understand, debug, and eventually test.
  </action>
  <verify>
Open coshhgeneratorv5.html in browser:
1. Upload a PDF MSDS file - should parse without errors
2. Check parsed data preview table - should show extracted fields
3. Click "Apply Parsed Data" - should populate form fields
4. Try pasting MSDS text - should extract data
5. Check browser console - no errors
6. Verify HTML file is ~200-250 lines shorter
  </verify>
  <done>
- js/modules/msdsParser.js exists with parsing functions and JSDoc
- coshhgeneratorv5.html reduced by ~200-250 lines total (now ~1200-1230 lines)
- PDF parsing functionality works identically
- Text paste parsing works identically
- All extracted data appears correctly in preview table
- No console errors during MSDS operations
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm test passes (no breaking changes to tested modules)
- [ ] Manual testing: Open coshhgeneratorv5.html in browser, test all extracted functionality
- [ ] coshhgeneratorv5.html reduced from 1579 lines to ~1200-1230 lines
- [ ] Two new module files created with JSDoc documentation
- [ ] No console errors when using any feature
- [ ] All form and MSDS features work identically to before
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- coshhgeneratorv5.html reduced by ~350-400 lines
- Two new modules created: formManager.js (~150 lines), msdsParser.js (~250 lines)
- No breaking changes to existing functionality
- Code is more maintainable and navigable
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-01-SUMMARY.md`:

# Phase 4 Plan 1: JavaScript Module Extraction Summary

**Extracted 350+ lines of inline JavaScript to formManager and msdsParser modules**

## Accomplishments

- Extracted form handling logic (save/load/export/import) to js/modules/formManager.js
- Extracted MSDS parsing logic to js/modules/msdsParser.js
- Reduced coshhgeneratorv5.html from 1579 to ~1220 lines
- Added JSDoc documentation to all exported functions
- Maintained full backward compatibility with existing functionality

## Files Created/Modified

- `js/modules/formManager.js` - NEW: Form data management functions
- `js/modules/msdsParser.js` - NEW: MSDS parsing and data extraction
- `coshhgeneratorv5.html` - Reduced by ~360 lines, added module imports

## Decisions Made

[Extraction approach, window export strategy for compatibility, any edge cases handled]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 04-02-PLAN.md - Code Formatting & Style Consistency
</output>
