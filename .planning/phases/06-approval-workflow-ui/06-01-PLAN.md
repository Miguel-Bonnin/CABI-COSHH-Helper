---
phase: 06-approval-workflow-ui
plan: 01
type: execute
depends_on: []
files_modified: [js/modules/workflowManager.js, coshhgeneratorv5.html, css/layout.css]
---

<objective>
Implement mock approval workflow interface with status transitions, workflow action buttons, and visual progress tracking.

Purpose: Demonstrate the complete assessment lifecycle (draft → under_review → approved) to show IT the full workflow vision without backend infrastructure.
Output: Working workflow UI where lab managers submit assessments for review, assessors approve or request changes, and approved assessments become read-only.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 5 summaries (direct dependencies):
@.planning/phases/05-user-role-simulation/05-01-SUMMARY.md
@.planning/phases/05-user-role-simulation/05-02-SUMMARY.md
@.planning/phases/05-user-role-simulation/05-03-SUMMARY.md

# Key source files:
@js/modules/userRoles.js
@js/modules/formManager.js
@coshhgeneratorv5.html
@css/layout.css

**Tech stack available:**
- ES6 modules with window export pattern
- localStorage for persistence
- Role-based UI with hasPermission() checks
- data-requires-permission attribute pattern

**Established patterns from Phase 5:**
- _meta object in form data (creator, timestamps, assignment, status, version)
- currentAssessmentMeta module variable for preserving metadata
- applyRoleBasedUI() for permission-based visibility
- displayAssessmentMetadata() for metadata banner updates

**Constraining decisions:**
- Phase 5: Status values are 'draft', 'under_review', 'approved'
- Phase 5: _meta prefix for metadata fields
- Phase 5: hasPermission() checks instead of hard-coded role names
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workflow state transition logic</name>
  <files>js/modules/workflowManager.js, js/modules/formManager.js</files>
  <action>
Create new workflowManager.js module with status transition functions:

1. **canTransition(currentStatus, targetStatus)** - Validates allowed transitions:
   - draft → under_review (requires 'draft_assessment' permission AND assignedTo is set)
   - under_review → approved (requires 'approve' permission)
   - under_review → draft (requires 'approve' permission - send back for changes)
   - All other transitions return false

2. **transitionStatus(targetStatus)** - Performs the transition:
   - Validates with canTransition()
   - Updates _meta.status via formManager's currentAssessmentMeta
   - Adds _meta.statusHistory array entry: {from, to, by, byName, at}
   - Triggers saveLocally() to persist
   - Returns {success: boolean, error?: string}

3. **getAvailableActions(status)** - Returns actions available for current status/role:
   - draft + lab_manager → ['submit_for_review'] (only if assignedTo is set)
   - under_review + assessor/admin → ['approve', 'request_changes']
   - approved → [] (no actions available)

4. **isReadOnly()** - Returns true if assessment is approved (no edits allowed)

Export to window.workflowManager for onclick handlers.

In formManager.js, add export for setCurrentAssessmentMeta if not already exposed, and ensure _meta.statusHistory is preserved when loading/importing.

Pattern note: Follow same module pattern as userRoles.js (ES6 exports + window.* for backward compatibility).
  </action>
  <verify>
Console test in browser:
- workflowManager.canTransition('draft', 'under_review') returns true when assignedTo set
- workflowManager.canTransition('draft', 'approved') returns false (can't skip)
- workflowManager.getAvailableActions('draft') returns ['submit_for_review'] for lab_manager
  </verify>
  <done>
- workflowManager.js exists with canTransition, transitionStatus, getAvailableActions, isReadOnly
- Status transitions enforce correct workflow order
- _meta.statusHistory tracks transition audit trail
- All functions accessible via window.workflowManager
  </done>
</task>

<task type="auto">
  <name>Task 2: Add workflow action buttons and wire handlers</name>
  <files>coshhgeneratorv5.html, css/layout.css</files>
  <action>
Add workflow action buttons to the UI and wire them to workflowManager:

1. **Submit for Review button** (Tab 8: Acknowledge):
   - Add button after finalDateSigned row: "Submit for Review"
   - Visible when: status === 'draft' AND hasPermission('draft_assessment') AND assignedTo is set
   - CSS class: .workflow-action-button .submit-review-button
   - Handler: calls workflowManager.transitionStatus('under_review'), shows confirmation, updates UI

2. **Request Changes button** (assessor approval section):
   - Add next to existing "Approve & Finalize" button
   - Visible when: status === 'under_review' AND hasPermission('approve')
   - CSS class: .workflow-action-button .request-changes-button
   - Handler: calls workflowManager.transitionStatus('draft'), shows confirmation with optional comment

3. **Wire existing Approve & Finalize button**:
   - Handler: calls workflowManager.transitionStatus('approved'), shows success message
   - After approval: disable all form inputs (read-only mode)

4. **Update applyRoleBasedUI()** to call new updateWorkflowActions() function:
   - updateWorkflowActions() shows/hides workflow buttons based on current status and permissions
   - Call after role switch and after any status change

5. **Add read-only mode**:
   - When isReadOnly() returns true, add 'assessment-readonly' class to form
   - CSS rule: .assessment-readonly input, .assessment-readonly select, .assessment-readonly textarea { pointer-events: none; opacity: 0.7; }
   - Show banner: "This assessment has been approved and is read-only"

Button styling: Use existing .approve-button pattern (green background) for approve actions, yellow for request changes, blue for submit.
  </action>
  <verify>
Manual test in browser:
1. As lab_manager with draft assessment and assignedTo set: "Submit for Review" button visible
2. Click submit → status changes to under_review, button disappears
3. Switch to assessor → "Approve & Finalize" and "Request Changes" visible
4. Click approve → status changes to approved, form becomes read-only
  </verify>
  <done>
- "Submit for Review" button functional for draft assessments
- "Request Changes" button functional for assessors
- "Approve & Finalize" button wired to approval transition
- Read-only mode activates for approved assessments
- Buttons show/hide based on status and permissions
  </done>
</task>

<task type="auto">
  <name>Task 3: Add workflow status visualization</name>
  <files>coshhgeneratorv5.html, css/layout.css</files>
  <action>
Add visual workflow progress indicator and enhance status display:

1. **Status progress indicator** (add to metadata banner area):
   - Three-step horizontal tracker: Draft → Under Review → Approved
   - Current step highlighted, completed steps checked
   - HTML structure:
     ```html
     <div class="workflow-progress">
       <div class="workflow-step completed" data-status="draft">
         <span class="step-icon">✓</span>
         <span class="step-label">Draft</span>
       </div>
       <div class="workflow-connector"></div>
       <div class="workflow-step current" data-status="under_review">
         <span class="step-icon">2</span>
         <span class="step-label">Under Review</span>
       </div>
       <div class="workflow-connector"></div>
       <div class="workflow-step" data-status="approved">
         <span class="step-icon">3</span>
         <span class="step-label">Approved</span>
       </div>
     </div>
     ```

2. **updateWorkflowProgress(status) function**:
   - Updates step classes based on current status
   - draft: step 1 current, 2-3 pending
   - under_review: step 1 completed, 2 current, 3 pending
   - approved: steps 1-2 completed, 3 current (with checkmark)

3. **Enhance metadata banner**:
   - Add workflow progress indicator above or below existing content
   - Add status-specific messaging:
     - draft: "This assessment is a draft. Complete all sections and submit for review."
     - under_review: "Awaiting review by [assignedTo name]. You will be notified when approved."
     - approved: "Approved by [approver name] on [date]. Ready for use."

4. **CSS styling for workflow progress**:
   - Horizontal flexbox layout
   - Step circles with numbers/checkmarks
   - Connector lines between steps
   - Color coding: gray (pending), blue (current), green (completed/approved)

5. **Call updateWorkflowProgress()** from:
   - displayAssessmentMetadata() after load/import
   - transitionStatus() after successful transition
   - Initial page load
  </action>
  <verify>
Visual check in browser:
1. Load draft assessment → progress shows step 1 (Draft) as current
2. Submit for review → progress shows step 1 completed, step 2 (Under Review) current
3. Approve → progress shows all steps completed with checkmarks
4. Status messages display correctly for each state
  </verify>
  <done>
- Workflow progress indicator displays current status visually
- Step tracker shows completed/current/pending states
- Status-specific messages provide context to users
- Progress updates on status changes
- Clean CSS styling consistent with existing design
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] All three status transitions work: draft→under_review, under_review→approved, under_review→draft
- [ ] Status persists across save/load/export/import cycles
- [ ] Workflow buttons appear for correct roles and statuses
- [ ] Read-only mode prevents editing of approved assessments
- [ ] Progress indicator accurately reflects current status
- [ ] No JavaScript errors in console during workflow operations
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Complete workflow demo: lab manager drafts → assigns → submits → assessor reviews → approves
- Visual progress indicator shows workflow state clearly
- Approved assessments are locked from editing
- Phase 6 complete - milestone 1 (v0.6.0) demonstration ready
</success_criteria>

<output>
After completion, create `.planning/phases/06-approval-workflow-ui/06-01-SUMMARY.md`:

# Phase 6 Plan 1: Approval Workflow UI Summary

**[Substantive one-liner - what shipped]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
[Phase 6 complete - Milestone 1 achieved]
</output>
