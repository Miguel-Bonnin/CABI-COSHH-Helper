---
phase: 05-user-role-simulation
plan: 02
type: execute
depends_on: ["05-01"]
files_modified: [coshhgeneratorv5.html, css/layout.css]
---

<objective>
Implement role-aware UI visibility and permission indicators throughout the application.

Purpose: Show different capabilities per role visually, demonstrating how lab managers see draft-only views while assessors see review capabilities.
Output: Role-aware UI with conditional visibility, disabled states, and permission indicators.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-user-role-simulation/05-01-SUMMARY.md
@js/modules/userRoles.js
@coshhgeneratorv5.html

**Tech stack available:**
- userRoles module with hasPermission() and getCurrentUser()
- Established UI patterns in coshhgeneratorv5.html
- Existing CSS in css/layout.css for styling

**From Phase 5 Plan 1:**
- Role types: lab_manager, coshh_assessor, admin
- Permission model: draft_assessment, edit_own, review_any, approve, admin
- Current user state available via getCurrentUser()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add role-aware permission indicators to UI</name>
  <files>coshhgeneratorv5.html, css/layout.css</files>
  <action>
Add visual indicators and role-aware behavior throughout the UI:

1. **Create applyRoleBasedUI() function in main script section:**
   - Get current user via getCurrentUser()
   - Query hasPermission() for key permissions
   - Apply role-specific UI changes based on permissions:

2. **Personnel tab (personnelTab) indicators:**
   - Add info banner at top of tab: "You are creating this assessment as [Role Name]"
   - If NOT hasPermission('draft_assessment'): Disable "Carried Out By" field, show warning "Only Lab Managers can draft new assessments"
   - If hasPermission('review_any'): Show additional text "(You can review any assessment)"

3. **Acknowledge/Review tab (ackReviewTab) indicators:**
   - If hasPermission('approve'): Show approval section (new div)
   - Approval section HTML (only visible to assessors/admin):
     ```html
     <div id="assessorApprovalSection" class="assessor-only">
       <h4>COSHH Assessor Approval</h4>
       <label><input type="checkbox" id="assessorApproved" name="assessorApproved"> I approve this assessment as compliant</label>
       <div class="column-layout">
         <div class="column"><label>Assessor Name:</label><input type="text" id="assessorName"></div>
         <div class="column"><label>Approval Date:</label><input type="date" id="assessorApprovalDate"></div>
       </div>
     </div>
     ```
   - If NOT hasPermission('approve'): Hide or grey out approval section

4. **Output tab (outputTab) indicators:**
   - If NOT hasPermission('review_any'): Add notice "This assessment requires COSHH Assessor review before final approval"
   - If hasPermission('approve'): Show "Approve & Finalize" button (styled prominently)

5. **CSS styling in css/layout.css:**
   - .role-indicator: background #f0f8ff, border-left 4px solid #4a90e2, padding 10px, margin 10px 0
   - .permission-warning: background #fff3cd, border-left 4px solid #ffc107, padding 10px
   - .assessor-only: border 2px solid #28a745, padding 15px, margin 10px 0
   - .disabled-for-role: opacity 0.6, pointer-events none

6. **Call applyRoleBasedUI():**
   - In DOMContentLoaded after role switcher initialization
   - Also call when user switches roles (in role switcher change handler)

**Implementation approach:**
- Use hasPermission() checks, NOT direct role name checks (more flexible)
- Add data attributes to elements: data-requires-permission="approve"
- Function loops through all [data-requires-permission] elements, hides/disables based on current user
- Keep logic in applyRoleBasedUI() centralized (single source of truth)

**What to avoid:**
- Don't duplicate permission logic across multiple functions
- Don't hard-code role names in UI code (use hasPermission instead)
- Don't hide essential form fields (grey out instead for transparency)
  </action>
  <verify>
npm run build (if applicable) completes without errors
Open coshhgeneratorv5.html, switch between roles:
- Lab Manager: See draft indicators, no approval section
- COSHH Assessor: See approval section, review indicators
- Admin: See all features enabled
  </verify>
  <done>
- applyRoleBasedUI() function created and calls successfully
- Role indicators appear in Personnel tab based on current user
- Approval section visible only to assessors/admin
- CSS styling applied correctly (blue info boxes, yellow warnings, green approval)
- Switching roles triggers UI updates immediately
- No JavaScript errors in console
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Role-aware UI visibility with permission indicators across all tabs</what-built>
  <how-to-verify>
1. Open coshhgeneratorv5.html in browser
2. Switch to Lab Manager role (e.g., Sarah Johnson)
   - Personnel tab: Should show "You are creating this assessment as Lab Manager"
   - Acknowledge tab: Should NOT show assessor approval section
   - Output tab: Should show notice about requiring assessor review
3. Switch to COSHH Assessor role
   - Personnel tab: Should show "(You can review any assessment)"
   - Acknowledge tab: Should show green "COSHH Assessor Approval" section with checkbox
   - Output tab: Should show "Approve & Finalize" button
4. Switch to Admin role
   - All features should be visible and enabled
5. Confirm UI updates immediately when switching roles (no page refresh needed)
6. Check CSS styling: Blue info boxes, yellow warnings, green approval section
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] applyRoleBasedUI() function works without errors
- [ ] Role indicators appear correctly per role type
- [ ] Approval section visible only to assessors/admin
- [ ] CSS styling renders correctly (colors, borders, padding)
- [ ] Switching roles updates UI immediately
- [ ] No JavaScript errors or console warnings
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Role-aware UI updates based on current user permissions
- Visual indicators clearly distinguish role capabilities
- Approval section conditional on hasPermission('approve')
- UI updates instantly when switching roles
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/05-user-role-simulation/05-02-SUMMARY.md`:

# Phase 5 Plan 2: Role-Based UI Visibility Summary

**Role-aware interface with conditional visibility and permission indicators**

## Accomplishments

- Created applyRoleBasedUI() function for centralized permission-based UI updates
- Added role indicators to Personnel tab (role context banner)
- Implemented assessor approval section in Acknowledge/Review tab (visible to assessors/admin only)
- Added permission warnings for restricted actions
- CSS styling for role-based elements (info boxes, warnings, approval sections)
- UI updates dynamically when user switches roles (no page refresh)

## Files Created/Modified

- `coshhgeneratorv5.html` - Added applyRoleBasedUI() function, role indicators, approval section
- `css/layout.css` - Added styles for role-indicator, permission-warning, assessor-only classes

## Decisions Made

- Used hasPermission() checks instead of hard-coded role names for flexibility
- data-requires-permission attribute pattern for declarative permission requirements
- Approval section in Acknowledge tab (not separate tab) to keep UI compact
- Immediate UI updates on role switch (no page reload) for better demo experience
- Visual styling uses color coding: blue (info), yellow (warning), green (approval)

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 05-03-PLAN.md (Assessment Ownership & Assignment)
</output>
