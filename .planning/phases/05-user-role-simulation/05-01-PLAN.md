---
phase: 05-user-role-simulation
plan: 01
type: execute
depends_on: []
files_modified: [js/modules/userRoles.js, coshhgeneratorv5.html]
---

<objective>
Create mock user role system with data model and role switching UI.

Purpose: Establish the foundation for role-based workflow simulation, demonstrating to IT how different user types (assessors, lab managers, admin) would interact with the system.
Output: Working role module with localStorage persistence and header-based role switcher.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@js/modules/formManager.js
@coshhgeneratorv5.html

**Tech stack available:**
- ES6 modules with window export pattern (established in Phase 4)
- LocalStorage persistence pattern (from formManager.js)
- Module import structure already in HTML

**Established patterns:**
- Module pattern: Export to window alongside ES6 exports for gradual migration
- State management: Use getter/setter exports for shared state between modules
- Configuration modules in js/config/ for data structures

**Constraining decisions:**
- Frontend-only implementation (no backend, no real authentication)
- LocalStorage for all persistence
- Must maintain compatibility with existing form save/load
- Vanilla JavaScript (no frameworks)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create userRoles.js module with role definitions and storage</name>
  <files>js/modules/userRoles.js</files>
  <action>
Create js/modules/userRoles.js module that defines:

1. **Role types and permissions:**
   - ROLES constant object with three roles:
     - 'lab_manager': Can draft assessments, view own assessments
     - 'coshh_assessor': Can review/edit all assessments, approve assessments
     - 'admin': Full access to all features, manage users (mock)

2. **Mock user profiles:**
   - mockUsers array with 5-6 preset profiles (2 lab managers, 2 assessors, 1 admin)
   - Each profile: { id, name, email, role, department }
   - Example: { id: 'u1', name: 'Sarah Johnson', email: 'sarah.j@cabi.org', role: 'lab_manager', department: 'Molecular Biology' }

3. **Current user state management:**
   - getCurrentUser() - Returns current user from localStorage (key: 'cabiCoshh_currentUser')
   - setCurrentUser(userId) - Sets current user, persists to localStorage
   - getUserById(userId) - Returns user profile by ID
   - getDefaultUser() - Returns first lab manager (initial state)

4. **Role query helpers:**
   - hasPermission(permission) - Checks if current user has given permission
   - Permissions: 'draft_assessment', 'edit_own', 'review_any', 'approve', 'admin'
   - Use simple role-to-permission mapping (lab_manager: draft/edit_own, assessor: all except admin, admin: all)

5. **Module exports:**
   - Export all functions as ES6 exports
   - Expose via window.userRoles for backward compatibility
   - Follow established pattern from formManager.js and msdsParser.js

**Implementation notes:**
- Keep it simple - this is mock data, not real security
- Use localStorage key 'cabiCoshh_currentUser' to store current user ID (string)
- Initialize with getDefaultUser() if no current user in storage
- Add JSDoc comments for all exported functions (@param, @returns)
- No validation needed - users are selecting from preset list only
  </action>
  <verify>
node -e "import('./js/modules/userRoles.js').then(m => { console.log('Module loaded'); console.log('Roles:', Object.keys(m.ROLES)); console.log('Mock users:', m.mockUsers.length); })"
  </verify>
  <done>
- Module creates successfully with ROLES constant and mockUsers array
- getCurrentUser/setCurrentUser persist to localStorage correctly
- hasPermission returns correct boolean for each role/permission combo
- All functions have JSDoc comments
- Module exports work in ES6 and window.userRoles available
  </done>
</task>

<task type="auto">
  <name>Task 2: Add role switcher UI to application header</name>
  <files>coshhgeneratorv5.html</files>
  <action>
Add role switching dropdown to the app header (before the title):

1. **HTML structure in app-header div (before h1):**
```html
<div class="role-switcher">
    <label for="currentUserSelect">Logged in as:</label>
    <select id="currentUserSelect">
        <!-- Options populated by JavaScript -->
    </select>
    <span id="currentRoleBadge" class="role-badge"></span>
</div>
```

2. **Import userRoles module in script section:**
   - Add import statement: `import { getCurrentUser, setCurrentUser, mockUsers, ROLES } from './js/modules/userRoles.js';`
   - Place with other module imports (after logger, before riskCalculator)

3. **Initialize role switcher in DOMContentLoaded:**
   - Populate select dropdown with mockUsers (option value=userId, text=name + role)
   - Set selected option to getCurrentUser().id
   - Update role badge with current role display name
   - Add change event listener: on change, call setCurrentUser(selectedUserId), update badge, log INFO message

4. **Styling (inline in existing <style> or reference css/layout.css):**
   - .role-switcher: display flex, align-items center, gap 10px, margin-right auto
   - .role-badge: padding 4px 8px, border-radius 4px, font-size 0.85em, font-weight bold
   - Role-specific badge colors: lab_manager (blue), coshh_assessor (green), admin (red)
   - Keep header layout clean - role switcher floats left of title

**Why this approach:**
- Visible role context at all times (users know "who they are")
- Quick switching for demonstration purposes
- No authentication UI needed - selection IS the "login"
- Follows existing app-header structure pattern

**What to avoid:**
- Don't add login/logout buttons (unnecessary complexity)
- Don't add password fields (this is mock only)
- Don't hide the switcher (defeats demonstration purpose)
  </action>
  <verify>
Open coshhgeneratorv5.html in browser:
- Role switcher dropdown appears in header before title
- Dropdown contains all mockUsers with readable names and roles
- Selecting different user updates badge color and text
- Selection persists across page refreshes (localStorage)
- Browser console shows no errors
  </verify>
  <done>
- Role switcher UI visible in header with dropdown and badge
- All mock users appear in dropdown with correct names/roles
- Badge color changes based on role (blue/green/red)
- Selection persists via localStorage (survives page reload)
- Console log confirms user switching events
- No JavaScript errors in console
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] userRoles.js module loads without errors in browser console
- [ ] Role switcher appears in header with all mock users
- [ ] Switching roles updates badge color and persists across reload
- [ ] No TypeScript/JavaScript errors introduced
- [ ] Module follows established patterns (ES6 + window export)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- userRoles.js module working with ROLES, mockUsers, storage functions
- Role switcher UI functional in header
- Role selection persists via localStorage
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/05-user-role-simulation/05-01-SUMMARY.md`:

# Phase 5 Plan 1: User Role Data Model & Storage Summary

**Mock user role system established with role switcher UI**

## Accomplishments

- Created userRoles.js module with 3 role types (lab_manager, coshh_assessor, admin)
- Defined 5-6 mock user profiles with role assignments
- Implemented localStorage persistence for current user state
- Added role switcher dropdown to application header
- Role badge with color-coding (blue/green/red) for visual role identification
- Permission checking system with hasPermission() helper

## Files Created/Modified

- `js/modules/userRoles.js` - Role data model, mock users, storage functions
- `coshhgeneratorv5.html` - Added role switcher UI to header, imported userRoles module

## Decisions Made

- Used localStorage key 'cabiCoshh_currentUser' for current user persistence
- Mock users include id, name, email, role, department for realistic demonstration
- Role switcher always visible in header (no hiding) for clear demonstration
- Permission model simplified to role-based (no fine-grained permissions yet)
- Three roles sufficient to demonstrate workflow: drafter → reviewer → admin

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 05-02-PLAN.md (Role-Based UI Visibility)
</output>
