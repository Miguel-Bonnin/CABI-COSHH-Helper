---
phase: 05-user-role-simulation
plan: 03
type: execute
depends_on: ["05-01", "05-02"]
files_modified: [js/modules/formManager.js, coshhgeneratorv5.html]
---

<objective>
Track assessment ownership and add assignment capabilities to demonstrate multi-user workflow.

Purpose: Show how assessments are created by one user and assigned to others for review, demonstrating the collaboration workflow to IT.
Output: Assessment data includes creator/owner info, assignment tracking, and visual ownership indicators.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-user-role-simulation/05-01-SUMMARY.md
@.planning/phases/05-user-role-simulation/05-02-SUMMARY.md
@js/modules/userRoles.js
@js/modules/formManager.js
@coshhgeneratorv5.html

**Tech stack available:**
- userRoles module with getCurrentUser(), getUserById(), mockUsers
- formManager module with collectFormData(), populateFormWithData()
- LocalStorage persistence pattern established

**From Phase 5 Plan 1:**
- Current user state available via getCurrentUser()
- Mock user profiles with id, name, email, role

**From Phase 5 Plan 2:**
- applyRoleBasedUI() function for role-aware display
- Permission-based UI indicators established
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend form data model with ownership and assignment tracking</name>
  <files>js/modules/formManager.js, coshhgeneratorv5.html</files>
  <action>
Extend assessment data to include creator, assignment, and status tracking:

1. **Modify collectFormData() in formManager.js:**
   - After collecting form data, add metadata fields:
   ```javascript
   // Add assessment metadata (after FormData collection)
   data._meta = {
     createdBy: getCurrentUser().id,
     createdByName: getCurrentUser().name,
     createdAt: data._meta?.createdAt || new Date().toISOString(),
     lastModifiedBy: getCurrentUser().id,
     lastModifiedAt: new Date().toISOString(),
     assignedTo: data.assignedToAssessor || null, // From form field
     status: data._meta?.status || 'draft', // draft, under_review, approved
     version: (data._meta?.version || 0) + 1
   };
   ```

2. **Import userRoles in formManager.js:**
   - Add import at top: `import { getCurrentUser } from './userRoles.js';`
   - Expose via window if needed for backward compatibility

3. **Modify populateFormWithData() in formManager.js:**
   - When loading data, check if _meta exists
   - Populate assignedToAssessor field if it exists
   - Display ownership info (handled in Task 2)

4. **Add assignment field to Personnel tab in coshhgeneratorv5.html:**
   - After "Carried Out By" field, add:
   ```html
   <div class="column">
     <label for="assignedToAssessor">Assign to COSHH Assessor:</label>
     <select id="assignedToAssessor" name="assignedToAssessor">
       <option value="">-- Not yet assigned --</option>
       <!-- Options populated from mockUsers (assessors only) -->
     </select>
   </div>
   ```

5. **Populate assessor dropdown in DOMContentLoaded:**
   - Filter mockUsers where role === 'coshh_assessor' or role === 'admin'
   - Create option elements with user.id as value, user.name as text
   - Append to assignedToAssessor select

6. **Handle assignment in applyRoleBasedUI():**
   - If current user is lab_manager: Can assign to assessors
   - If current user is assessor/admin: Can see assigned assessments
   - If NOT hasPermission('draft_assessment'): Disable assignment field

**Implementation notes:**
- _meta field prefixed with underscore (metadata, not form data)
- createdAt never changes, lastModifiedAt updates on every save
- status field prepared for Phase 6 (approval workflow)
- version increments on each save (simple change tracking)

**What to avoid:**
- Don't implement status transitions yet (Phase 6 handles workflow)
- Don't add approval logic here (that's in Phase 6)
- Don't validate assignment (accept any selected user for now)
  </action>
  <verify>
Save assessment as Lab Manager:
- LocalStorage data includes _meta object with createdBy, createdByName, etc.
- assignedToAssessor field saved correctly
- Load assessment: _meta fields populate correctly
- Assignment dropdown populated with assessor names only
  </verify>
  <done>
- collectFormData() adds _meta object with all tracking fields
- populateFormWithData() restores _meta fields correctly
- Assignment dropdown in Personnel tab shows assessors only
- LocalStorage contains _meta with creator/assignment info
- No JavaScript errors when saving/loading with new fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ownership indicators and assignment status display</name>
  <files>coshhgeneratorv5.html</files>
  <action>
Display assessment ownership and assignment information throughout UI:

1. **Create displayAssessmentMetadata() function:**
   - Check if form has loaded data with _meta field
   - If _meta exists, show ownership info banner at top of form
   - Banner HTML (insert after app-header, before app-container):
   ```javascript
   function displayAssessmentMetadata() {
     const formData = collectFormData(document.getElementById('coshhFullForm'));
     const meta = formData._meta;

     let existingBanner = document.getElementById('assessmentMetaBanner');
     if (existingBanner) existingBanner.remove();

     if (!meta) return; // New assessment, no metadata yet

     const banner = document.createElement('div');
     banner.id = 'assessmentMetaBanner';
     banner.className = 'assessment-meta-banner';
     banner.innerHTML = `
       <strong>Assessment Info:</strong>
       Created by ${meta.createdByName} on ${new Date(meta.createdAt).toLocaleDateString()} |
       Last modified: ${new Date(meta.lastModifiedAt).toLocaleString()} |
       Status: <span class="status-badge status-${meta.status}">${meta.status}</span>
       ${meta.assignedTo ? `| Assigned to: ${getUserById(meta.assignedTo)?.name || 'Unknown'}` : ''}
     `;
     document.querySelector('.app-container').insertAdjacentElement('beforebegin', banner);
   }
   ```

2. **Call displayAssessmentMetadata():**
   - After loadLocally() completes (in load function)
   - After importFromJsonFile() completes
   - When switching roles (in role switcher change handler)

3. **Add CSS styling for metadata banner:**
   - In coshhgeneratorv5.html style section or css/layout.css:
   ```css
   .assessment-meta-banner {
     background: #e8f4f8;
     border: 1px solid #b8dae8;
     padding: 12px;
     margin: 10px 20px;
     border-radius: 4px;
     font-size: 0.9em;
   }
   .status-badge {
     padding: 2px 8px;
     border-radius: 3px;
     font-weight: bold;
     font-size: 0.85em;
   }
   .status-draft { background: #ffc107; color: #000; }
   .status-under_review { background: #17a2b8; color: #fff; }
   .status-approved { background: #28a745; color: #fff; }
   ```

4. **Update assignment dropdown on role switch:**
   - In role switcher change handler, call applyRoleBasedUI()
   - applyRoleBasedUI() should update assignment dropdown based on permissions

5. **Add assignment change notification:**
   - When assignedToAssessor select changes, log INFO message
   - Message: "Assessment will be assigned to [Name] for review"
   - Use logger.logInfo() if available

**Visual design:**
- Metadata banner appears between header and main form (prominent but not intrusive)
- Status badges color-coded: Yellow (draft), Teal (under review), Green (approved)
- Assignment shows assigned user's name (not just ID)
- Banner updates when loading different assessments

**What to avoid:**
- Don't add edit functionality to metadata banner (metadata is auto-tracked)
- Don't show banner for brand new assessments (only loaded ones)
- Don't duplicate ownership info in multiple places (banner is single source)
  </action>
  <verify>
1. Create new assessment as Lab Manager, assign to assessor, save
2. Reload page, load assessment
3. Verify metadata banner appears with:
   - Creator name and date
   - Last modified timestamp
   - Status badge (draft)
   - Assigned assessor name
4. Switch to different mock user, verify banner updates
5. Check CSS styling: blue banner, colored status badges
  </verify>
  <done>
- displayAssessmentMetadata() function created and working
- Metadata banner appears when loading saved assessments
- Banner shows creator, modified date, status, and assignment
- Status badges styled with correct colors (yellow/teal/green)
- Assignment shows user name (not just ID)
- Banner updates when switching users or loading different data
- No JavaScript errors in console
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Assessment ownership tracking with creator info, assignment capabilities, and metadata display banner</what-built>
  <how-to-verify>
1. Open coshhgeneratorv5.html, switch to Lab Manager role
2. Create new assessment:
   - Fill in "Carried Out By" field with your name
   - Select a COSHH Assessor from "Assign to COSHH Assessor" dropdown
   - Fill in some basic substance info (chemical name)
   - Click "Save Form Data Locally"
3. Verify save successful, then click "Load Saved Data"
4. Confirm metadata banner appears above form showing:
   - "Created by [Lab Manager Name] on [date]"
   - "Last modified: [timestamp]"
   - "Status: draft" with yellow badge
   - "Assigned to: [Assessor Name]"
5. Switch to COSHH Assessor role in header dropdown
6. Load the same assessment, verify metadata banner still shows correctly
7. Make a small edit (change chemical name), save again
8. Reload and verify "Last modified" timestamp updated
9. Export to JSON, check that _meta object exists with all fields
10. Check console for any errors
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] formManager.js collectFormData adds _meta object
- [ ] populateFormWithData restores _meta fields
- [ ] Assignment dropdown populated with assessors only
- [ ] displayAssessmentMetadata() shows banner with all info
- [ ] Status badges styled correctly (yellow/teal/green)
- [ ] Assignment displays user name (not ID)
- [ ] Metadata persists through save/load cycle
- [ ] No JavaScript errors or console warnings
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Assessment data includes _meta with creator, modifier, timestamps, assignment
- Assignment dropdown allows selecting assessors for review
- Metadata banner displays ownership and status information
- Status badges color-coded appropriately
- Assignment shows human-readable user names
- All features work across role switching
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/05-user-role-simulation/05-03-SUMMARY.md`:

# Phase 5 Plan 3: Assessment Ownership & Assignment Summary

**Assessment tracking with creator info, assignment workflow, and metadata display**

## Accomplishments

- Extended form data model with _meta object (creator, timestamps, assignment, status, version)
- Modified formManager.js to automatically track creator and modifier with timestamps
- Added assignment dropdown to Personnel tab (select from assessors only)
- Created displayAssessmentMetadata() function for ownership banner
- Implemented metadata banner showing creator, modified time, status, and assignment
- Status badge styling with color coding (yellow draft, teal review, green approved)
- Assignment displays user names instead of IDs for readability
- Version tracking on each save for change history

## Files Created/Modified

- `js/modules/formManager.js` - Added _meta tracking to collectFormData, getUserRoles import
- `coshhgeneratorv5.html` - Added assignment dropdown, displayAssessmentMetadata(), metadata banner CSS

## Decisions Made

- _meta prefix for metadata fields (distinguishes from form data)
- createdAt timestamp never changes, lastModifiedAt updates on every save
- version increments on each save (simple change tracking for future audit trail)
- status field values: 'draft', 'under_review', 'approved' (prepared for Phase 6)
- Assignment dropdown shows assessors + admins only (lab managers cannot review)
- Metadata banner positioned between header and form (prominent visibility)

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 5 complete. Ready for Phase 6: Approval Workflow UI
</output>
