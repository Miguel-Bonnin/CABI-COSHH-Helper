---
phase: 02-runtime-safety
plan: 02
type: execute
depends_on: []
files_modified: [js/inventory-manager.js, js/eh40-loader.js, coshhgeneratorv5.html]
---

<objective>
Add error handling and recovery mechanisms to data loading operations to prevent silent failures and provide user feedback.

Purpose: Replace implicit failures in fetch operations with explicit error handling, user-facing messages, and graceful degradation so users understand when data fails to load and can retry.
Output: Robust data loading with try-catch wrappers, retry logic, and user-visible error states.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@js/inventory-manager.js
@js/eh40-loader.js

**Tech stack available:**
- Vitest test framework (for testing error scenarios)
- ES6 modules and async/await patterns
- Fetch API for HTTP requests
- LocalStorage for persistence

**Established patterns:**
- Pure function design where possible
- Clear separation between data operations and UI updates
- Console logging for debugging

**Current issues:**
- inventory-manager.js has basic error handling but no retry logic
- eh40-loader.js logs errors to console but doesn't inform user
- No visual feedback when data loads successfully vs fails
- No recovery mechanisms for transient network failures
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retry logic and enhanced error handling to data loaders</name>
  <files>js/inventory-manager.js, js/eh40-loader.js</files>
  <action>
Create a reusable `fetchWithRetry` helper function at top of each file:
- Accepts (url, maxRetries=3, delay=1000) parameters
- Implements exponential backoff: wait delay * (2^attempt) ms between retries
- Retries on network errors and 5xx responses (not 4xx - those are permanent)
- Returns response or throws descriptive error after exhausting retries

Update existing fetch calls:
- In inventory-manager.js: Wrap both fetch calls in loadInventoryData() with fetchWithRetry
- In eh40-loader.js: Wrap fetch call in loadEH40Data() with fetchWithRetry
- Preserve existing error handling logic (console.error, return false)
- Add error context: include URL and attempt number in error messages

**What to avoid and WHY:**
- Don't retry on 4xx errors (client errors like 404) - these are permanent, retrying wastes time
- Don't use alert() for errors - too intrusive, prefer in-page messages (next task)
- Don't make maxRetries configurable by caller yet - keep it simple with sensible defaults
  </action>
  <verify>
1. Search code: grep -n "fetchWithRetry" confirms helper exists in both files
2. Search code: grep -n "fetch(" confirms all fetch calls now use fetchWithRetry
3. Manual test: Disconnect network, trigger data load → console shows retry attempts
4. Manual test: Invalid URL → error message includes URL context
  </verify>
  <done>
- fetchWithRetry helper implemented in both files
- All fetch operations use retry logic
- Exponential backoff implemented correctly
- Error messages include contextual information
- Console logs show retry progress for debugging
  </done>
</task>

<task type="auto">
  <name>Task 2: Add user-facing error messages and recovery UI</name>
  <files>js/inventory-manager.js, js/eh40-loader.js, coshhgeneratorv5.html</files>
  <action>
**In inventory-manager.js:**
- Update showInventoryError() to display retry count and specific failure reason
- Add a "Retry" button to error message that calls initializeInventory() again
- Change error message style to be informative not alarming (info blue, not danger red)
- Add success message after successful load (green notification, auto-dismiss after 2s)

**In eh40-loader.js:**
- Create showEH40Error() function similar to showInventoryError()
- Display error in welMatchStatus element with retry button
- Update success message to confirm data loaded: "✓ 2,500 substances loaded"
- Add loading state: "Loading EH40 data..." while fetch in progress

**In coshhgeneratorv5.html:**
- Find showInventoryError() calls and verify they're in inventory manager section
- No structural changes needed (error UI already uses dynamic injection)

**What to avoid and WHY:**
- Don't use generic "An error occurred" - be specific about what failed
- Don't make error messages technical (no stack traces) - user-friendly language only
- Don't block the UI permanently - always provide a way to retry or continue
- Don't auto-retry infinitely in the UI - user must explicitly click Retry after fetch exhaustion
  </action>
  <verify>
1. Manual test: Break inventory JSON path → error message appears with specific file name
2. Manual test: Click retry button → initializeInventory() called, loading attempted
3. Manual test: Successful load → green success message appears and auto-dismisses
4. Manual test: Break EH40 CSV path → welMatchStatus shows error with retry option
5. Check: Error messages are user-friendly (no "fetch failed", say "Could not load inventory data")
  </verify>
  <done>
- User-facing error messages implemented in both loaders
- Retry buttons functional and trigger reload
- Success confirmations provide positive feedback
- Loading states inform user of progress
- All error messages are non-technical and actionable
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] fetchWithRetry helper exists in both JS files
- [ ] All fetch calls use retry logic with exponential backoff
- [ ] Error messages include context (URL, reason, retry count)
- [ ] Retry buttons work and trigger data reload
- [ ] Success messages appear after successful load
- [ ] Manual testing confirms graceful degradation on network failures
- [ ] No console errors for handled error scenarios
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No breaking changes to existing functionality
- Error handling is comprehensive but not intrusive
- Users have clear path to recovery from failures
</success_criteria>

<output>
After completion, create `.planning/phases/02-runtime-safety/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Data Loading Error Handling Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1 - retry logic]
- [Key outcome 2 - user messaging]

## Files Created/Modified

- `js/inventory-manager.js` - [Description of changes]
- `js/eh40-loader.js` - [Description of changes]
- `coshhgeneratorv5.html` - [Description if modified]

## Decisions Made

[Key decisions about retry strategy, error message content, UI patterns]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for [02-03-PLAN.md] - DOM Safety Guards
</output>
