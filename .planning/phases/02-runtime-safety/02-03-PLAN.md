---
phase: 02-runtime-safety
plan: 03
type: execute
depends_on: []
files_modified: [js/modules/domHelpers.js, coshhgeneratorv5.html, js/inventory-manager.js, js/eh40-loader.js, js/floor-plan-viewer.js]
---

<objective>
Create safe DOM query helpers and refactor existing code to prevent null reference errors when elements don't exist.

Purpose: Replace brittle `document.getElementById()` and `querySelector()` calls with validated helpers that fail gracefully, logging warnings instead of crashing the application.
Output: Centralized DOM helper module with safe query functions and updated codebase using them throughout.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@coshhgeneratorv5.html
@js/inventory-manager.js
@js/eh40-loader.js
@js/floor-plan-viewer.js

**Tech stack available:**
- ES6 modules for code organization
- Vitest for testing (can add tests for DOM helpers)
- happy-dom for DOM simulation in tests

**Established patterns:**
- Pure function design where possible
- Helper function extraction for reusability
- Clear module boundaries with named exports

**Current issues:**
- Multiple `document.getElementById()` calls without null checks
- Silent failures when elements don't exist (operations just don't happen)
- No centralized place to add logging or debugging for missing elements
- Difficult to diagnose UI issues in production
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create safe DOM query helper module</name>
  <files>js/modules/domHelpers.js, tests/domHelpers.test.js</files>
  <action>
Create new module `js/modules/domHelpers.js` with the following helpers:

```javascript
/**
 * Safe DOM query helpers that prevent null reference errors
 */

/**
 * Safely get element by ID with optional warning
 * @param {string} id - Element ID
 * @param {boolean} warnIfMissing - Log warning if element not found (default: true)
 * @returns {HTMLElement|null}
 */
export function safeGetElementById(id, warnIfMissing = true) {
  const element = document.getElementById(id);
  if (!element && warnIfMissing) {
    console.warn(`[DOM] Element not found: #${id}`);
  }
  return element;
}

/**
 * Safely query selector with optional warning
 * @param {string} selector - CSS selector
 * @param {boolean} warnIfMissing - Log warning if element not found (default: true)
 * @returns {Element|null}
 */
export function safeQuerySelector(selector, warnIfMissing = true) {
  const element = document.querySelector(selector);
  if (!element && warnIfMissing) {
    console.warn(`[DOM] Element not found: ${selector}`);
  }
  return element;
}

/**
 * Safely set text content if element exists
 * @param {string} id - Element ID
 * @param {string} text - Text to set
 * @returns {boolean} - True if successful
 */
export function safeSetTextContent(id, text) {
  const element = safeGetElementById(id, true);
  if (element) {
    element.textContent = text;
    return true;
  }
  return false;
}

/**
 * Safely set inner HTML if element exists
 * @param {string} id - Element ID
 * @param {string} html - HTML to set
 * @returns {boolean} - True if successful
 */
export function safeSetInnerHTML(id, html) {
  const element = safeGetElementById(id, true);
  if (element) {
    element.innerHTML = html;
    return true;
  }
  return false;
}

/**
 * Safely add event listener if element exists
 * @param {string} id - Element ID
 * @param {string} event - Event name
 * @param {Function} handler - Event handler
 * @returns {boolean} - True if successful
 */
export function safeAddEventListener(id, event, handler) {
  const element = safeGetElementById(id, true);
  if (element) {
    element.addEventListener(event, handler);
    return true;
  }
  return false;
}
```

Create test file `tests/domHelpers.test.js`:
- Test each helper with existing and missing elements
- Verify warning messages are logged for missing elements
- Verify no warnings when warnIfMissing=false
- Test return values (element/null for queries, boolean for operations)

**What to avoid and WHY:**
- Don't throw errors on missing elements - graceful degradation is the goal
- Don't use these helpers in critical paths where element MUST exist - throw explicitly there
- Don't suppress all warnings - they help diagnose HTML structure issues during development
  </action>
  <verify>
npm test -- domHelpers
- All tests pass
- Helpers correctly return null for missing elements
- Console warnings appear when appropriate
- Operations return success/failure booleans
  </verify>
  <done>
- domHelpers.js module created and exported
- All 5 helper functions implemented with JSDoc
- Test suite validates behavior with existing/missing elements
- All tests passing
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor existing code to use safe DOM helpers</name>
  <files>coshhgeneratorv5.html, js/inventory-manager.js, js/eh40-loader.js, js/floor-plan-viewer.js</files>
  <action>
Import safe helpers at top of each file:
```javascript
import { safeGetElementById, safeSetTextContent, safeSetInnerHTML, safeAddEventListener } from './modules/domHelpers.js';
```

**In inventory-manager.js:**
- Replace all `document.getElementById()` with `safeGetElementById()`
- Replace `.textContent =` patterns with `safeSetTextContent()`
- Replace `.innerHTML =` patterns with `safeSetInnerHTML()`
- Priority locations: updateInventoryStats(), renderInventoryTable(), setupInventoryEventListeners()
- Keep null checks for logic branches (if element exists, do X), remove defensive checks that just prevent errors

**In eh40-loader.js:**
- Replace `document.getElementById('welMatchStatus')` with `safeGetElementById('welMatchStatus')`
- Replace status element updates with `safeSetTextContent()`
- Priority locations: loadEH40Data() success/error paths, matchSubstanceWEL()

**In floor-plan-viewer.js:**
- Replace canvas and container queries with safe versions
- Add warnings for missing floor plan UI elements
- Priority: initFloorPlanViewer(), updateFloorPlanDisplay()

**In coshhgeneratorv5.html:**
- Find inline `<script type="module">` sections
- Replace critical getElementById calls with safe versions
- Add import statement at top of script sections
- Focus on tab initialization and form value reading

**What to avoid and WHY:**
- Don't replace ALL getElementById calls blindly - if error should halt execution, keep the raw call
- Don't import helpers in non-module scripts - convert to modules or keep unsafe (temporary)
- Don't remove helpful null checks that branch logic - only remove defensive checks that prevent crashes
- Don't change behavior - this is a safety refactor, not a feature change
  </action>
  <verify>
1. Search: grep -n "getElementById" confirms critical paths now use safeGetElementById
2. Search: grep -n "querySelector" confirms critical paths now use safe version
3. Manual test: Open app in browser → check console for DOM warnings (should be minimal/none)
4. Manual test: Remove an element ID from HTML → app continues functioning, warning logged
5. Smoke test: All major features work (inventory load, EH40 lookup, risk calculation)
  </verify>
  <done>
- All JS files import domHelpers
- Critical DOM operations use safe helpers throughout
- Console logs helpful warnings for missing elements
- No breaking changes to existing functionality
- Codebase more resilient to HTML structure changes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] domHelpers.js module exists with 5+ helper functions
- [ ] domHelpers.test.js passes all tests
- [ ] All target files import and use safe helpers
- [ ] Manual browser test shows no null reference errors
- [ ] Console warnings appear for genuinely missing elements
- [ ] All major features still work correctly
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No regressions in existing functionality
- DOM manipulation is now fail-safe throughout codebase
- Phase 2 complete: Runtime safety infrastructure in place
</success_criteria>

<output>
After completion, create `.planning/phases/02-runtime-safety/02-03-SUMMARY.md`:

# Phase 2 Plan 3: DOM Safety Guards Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1 - helper module]
- [Key outcome 2 - codebase refactor]

## Files Created/Modified

### Created
- `js/modules/domHelpers.js` - [Description]
- `tests/domHelpers.test.js` - [Description]

### Modified
- `coshhgeneratorv5.html` - [Description]
- `js/inventory-manager.js` - [Description]
- `js/eh40-loader.js` - [Description]
- `js/floor-plan-viewer.js` - [Description]

## Decisions Made

[Key decisions about when to use safe vs unsafe queries, warning verbosity, helper API design]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

**Phase 2 Complete: Runtime Safety**

Ready for Phase 3: Documentation Excellence
- Validation guards protect calculation functions
- Error handling provides user feedback and recovery
- DOM operations fail gracefully with helpful warnings
- Codebase more maintainable and debuggable
</output>
