---
phase: 01-testing-foundation
plan: 03
type: tdd
depends_on: ["01-02"]
files_modified: [js/modules/riskCalculator.js, tests/riskCalculator.test.js, coshhgeneratorv5.html]
---

<objective>
Extract risk likelihood calculation from inline HTML and implement with TDD to ensure correctness during refactoring.

Purpose: Complete the risk calculator module with tested likelihood calculation. TDD ensures the complex multi-factor calculation is preserved correctly.
Output: Tested `calculateOverallLikelihood()` function completing the risk assessment logic.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-testing-foundation/DISCOVERY.md
@.planning/phases/01-testing-foundation/01-02-SUMMARY.md
@coshhgeneratorv5.html (line ~1100 - calculateOverallLikelihood function)
@js/config/procedures.js

**Current State:**
- `calculateOverallLikelihood()` embedded in HTML
- Reads procedure, quantity, frequency, duration from DOM
- Complex calculation: exposure factor + aerosol generation + quantity normalization
- Returns likelihood score 0-10

**Refactoring Goal:**
- Extract to `js/modules/riskCalculator.js` (same module as severity)
- Accept parameters: procedure object, quantity, unit, frequency, duration
- Keep identical calculation logic
- Update HTML to call module function
</context>

<feature>
  <name>Risk Likelihood Calculator</name>
  <files>js/modules/riskCalculator.js, tests/riskCalculator.test.js</files>
  <behavior>
**Function Signature:**
```javascript
calculateOverallLikelihood(procedureData, quantity, unit, frequency, duration)
// procedureData: object with exposureFactor, aerosolGeneration
// quantity: number (amount used)
// unit: string ('g', 'mg', 'mL', 'L')
// frequency: string ('daily', 'weekly', 'monthly', 'occasionally')
// duration: string ('continuous', 'frequent', 'occasional', 'rare')
// returns: integer 0-10 (likelihood score)
```

**Test Cases:**
1. High exposure procedure + large quantity → high likelihood (8-10)
2. Low exposure procedure + small quantity → low likelihood (0-2)
3. Aerosol generation adds to likelihood score
4. Quantity normalization: 1000mg = 1g equivalence
5. Frequency multipliers: daily > weekly > monthly
6. Duration multipliers: continuous > frequent > occasional
7. Edge case: zero quantity → minimum likelihood

**Calculation Logic** (from existing code):
- Base score from procedure exposureFactor (0-5)
- Add aerosol generation bonus if applicable
- Normalize quantity to base unit (mg or mL)
- Apply quantity factor (thresholds: <10, 10-100, 100-1000, >1000)
- Apply frequency multiplier
- Apply duration multiplier
- Cap at 10, floor at 0
  </behavior>
  <implementation>
After tests written and failing (RED):
1. Add calculateOverallLikelihood() to js/modules/riskCalculator.js
2. Implement quantity normalization helper (mg/g/kg, mL/L)
3. Implement likelihood calculation following existing logic
4. Export function as named export
5. Run tests - should pass (GREEN)
6. Refactor if needed - extract helpers, simplify (REFACTOR)
7. Update coshhgeneratorv5.html to import and call module function
  </implementation>
</feature>

<verification>
- [ ] `npm test` passes all tests (severity + likelihood)
- [ ] Likelihood calculation produces identical results to original
- [ ] Module exports both severity and likelihood functions
</verification>

<success_criteria>

- Failing test written and committed (RED)
- Implementation passes all tests (GREEN)
- Refactored if improvements found (REFACTOR)
- HTML updated to use module function
- All 2-3 commits present (test, feat, optional refactor)
- Phase 1 core testing infrastructure complete
  </success_criteria>

<output>
After completion, create `.planning/phases/01-testing-foundation/01-03-SUMMARY.md`:

# Phase 1 Plan 3: Risk Likelihood Calculator TDD Summary

**Extracted and tested calculateOverallLikelihood() completing core risk calculator module**

## Accomplishments

- RED: Wrote 7+ test cases covering likelihood calculation logic
- GREEN: Implemented calculateOverallLikelihood() with quantity normalization
- REFACTOR: [If applicable - extracted helpers, improved clarity]
- Updated HTML to use module functions for complete risk calculation

## Files Created/Modified

- `js/modules/riskCalculator.js` - Added likelihood calculation function
- `tests/riskCalculator.test.js` - Added TDD tests for likelihood calculator
- `coshhgeneratorv5.html` - Updated to import and call both risk functions

## Commits

1. `test(01-03): add failing tests for calculateOverallLikelihood`
2. `feat(01-03): extract calculateOverallLikelihood to riskCalculator module`
3. `refactor(01-03): [if applicable - extract quantity normalization helper]`

## Decisions Made

- Quantity normalization as separate helper function for clarity
- Kept complex multi-factor calculation logic identical to original
- Module now exports: calculateOverallSeverity, calculateOverallLikelihood

## Issues Encountered

[Document any issues - unit conversion edge cases, multiplier calculations, etc.]

## Next Phase Readiness

**Phase 1 Complete: Testing Foundation Established**

- ✅ Vitest test framework installed and configured
- ✅ Core risk calculation functions extracted and tested
- ✅ TDD workflow demonstrated (RED-GREEN-REFACTOR)
- ✅ Modular JavaScript architecture improved

**Ready for Phase 2: Runtime Safety**
- Validation checks can now be test-driven
- Error handling can be tested with new framework
- Regression prevention in place for future changes

**Concerns for Next Phase:**
- HTML still contains many inline functions (gradual extraction recommended)
- DOM-dependent code needs integration tests (future work)
- PDF parsing tests deferred (complex, requires fixtures)
</output>
