---
phase: 01-testing-foundation
plan: 02
type: tdd
depends_on: ["01-01"]
files_modified: [js/modules/riskCalculator.js, tests/riskCalculator.test.js, coshhgeneratorv5.html]
---

<objective>
Extract risk severity calculation from inline HTML and implement with TDD to ensure correctness during refactoring.

Purpose: Test-driven extraction ensures the refactored function behaves identically to the original implementation. TDD provides confidence that risk calculation logic is preserved.
Output: Tested, modular `calculateOverallSeverity()` function with comprehensive test coverage.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-testing-foundation/DISCOVERY.md
@.planning/phases/01-testing-foundation/01-01-SUMMARY.md
@coshhgeneratorv5.html (line 1067 - calculateOverallSeverity function)
@js/config/hazards.js

**Current State:**
- `calculateOverallSeverity()` embedded in HTML at line ~1067
- Function reads from DOM directly: `document.getElementById()`
- Uses global `hPhraseSeverityMap` from config
- Returns severity score 1-5 based on H-phrases and signal word

**Refactoring Goal:**
- Extract to `js/modules/riskCalculator.js` as pure function
- Accept parameters instead of reading DOM
- Keep identical calculation logic
- Update HTML to call module function
</context>

<feature>
  <name>Risk Severity Calculator</name>
  <files>js/modules/riskCalculator.js, tests/riskCalculator.test.js</files>
  <behavior>
**Function Signature:**
```javascript
calculateOverallSeverity(hPhrases, signalWord)
// hPhrases: array of strings (e.g., ['H350', 'H314'])
// signalWord: string ('Danger', 'Warning', or '')
// returns: integer 1-5 (severity score)
```

**Test Cases:**
1. H350 (carcinogen) → severity 5
2. H314 (severe skin burns) → severity 4
3. Signal Word 'Danger' with no H-phrases → severity 3
4. Signal Word 'Warning' with no H-phrases → severity 2
5. No hazards (empty array, no signal word) → severity 1
6. Multiple H-phrases → highest severity wins
7. Case insensitive H-phrase matching

**Calculation Logic** (from existing code):
- Iterate through hPhrases array
- Look up each phrase in hPhraseSeverityMap
- Track highest severity found
- If no H-phrases, use signal word: 'Danger' → 3, 'Warning' → 2, else → 1
- Return highest severity or signal word severity
  </behavior>
  <implementation>
After tests written and failing (RED):
1. Create js/modules/ directory if not exists
2. Create riskCalculator.js
3. Import hPhraseSeverityMap from '../config/hazards.js'
4. Implement calculateOverallSeverity() following existing logic
5. Export function as named export
6. Run tests - should pass (GREEN)
7. Refactor if needed - simplify, add comments (REFACTOR)
8. Update coshhgeneratorv5.html to import and call module function
  </implementation>
</feature>

<verification>
- [ ] `npm test` passes all tests
- [ ] Original HTML function still works until replacement complete
- [ ] Module function produces identical results to original
</verification>

<success_criteria>

- Failing test written and committed (RED)
- Implementation passes all tests (GREEN)
- Refactored if improvements found (REFACTOR)
- HTML updated to use module function
- All 2-3 commits present (test, feat, optional refactor)
  </success_criteria>

<output>
After completion, create `.planning/phases/01-testing-foundation/01-02-SUMMARY.md`:

# Phase 1 Plan 2: Risk Severity Calculator TDD Summary

**Extracted and tested calculateOverallSeverity() with TDD approach**

## Accomplishments

- RED: Wrote 7 test cases covering severity calculation logic
- GREEN: Implemented calculateOverallSeverity() as pure function
- REFACTOR: [If applicable - cleanup done]
- Updated HTML to use module function instead of inline code

## Files Created/Modified

- `js/modules/riskCalculator.js` - Extracted risk calculation functions
- `tests/riskCalculator.test.js` - TDD tests for severity calculator
- `coshhgeneratorv5.html` - Updated to import and call module function

## Commits

1. `test(01-02): add failing tests for calculateOverallSeverity`
2. `feat(01-02): extract calculateOverallSeverity to riskCalculator module`
3. `refactor(01-02): [if applicable]`

## Decisions Made

- Pure function design: parameters instead of DOM reads
- Named exports for tree-shaking compatibility
- Kept identical calculation logic (no behavior changes)

## Issues Encountered

[Document any issues - H-phrase case sensitivity, signal word handling, etc.]

## Next Step

Ready for 01-03-PLAN.md: Extract and test likelihood calculation function
</output>
