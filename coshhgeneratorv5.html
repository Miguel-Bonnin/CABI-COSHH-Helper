<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CABI COSHH Helper - Enhanced MSDS Parsing</title>
    <!-- External Stylesheets (Phase 1: Modularization) -->
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/tabs.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/print.css">
    <link rel="stylesheet" href="css/inventory.css">
    <link rel="stylesheet" href="css/floor-plan.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <!-- pdf.js worker script is set inside DOMContentLoaded -->
    <!-- Configuration Modules (Phase 2: Modularization) -->
    <script src="js/config/procedures.js"></script>
    <script src="js/config/hazards.js"></script>
    <script src="js/config/controls.js"></script>
    <!-- Logging Module (Phase 4: Code Quality) -->
    <script type="module" src="js/modules/logger.js"></script>
    <!-- EH40 Workplace Exposure Limits -->
    <script type="module" src="js/eh40-loader.js"></script>
    <!-- Inventory Management -->
    <script type="module" src="js/inventory-manager.js"></script>
    <!-- Floor Plan Viewer -->
    <script type="module" src="js/floor-plan-viewer.js"></script>
    <!-- Form Data Management (Phase 4: Modularization) -->
    <script type="module" src="js/modules/formManager.js"></script>
    <!-- MSDS Parsing (Phase 4: Modularization) -->
    <script type="module" src="js/modules/msdsParser.js"></script>
    <!-- Report Generation (Phase 4: Code Quality) -->
    <script type="module" src="js/modules/reportGenerator.js"></script>
</head>
<body>

<div class="app-header">
    <img src="https://www.cabi.org/wp-content/uploads/CABI-Logo_Accessible_RGB.png" alt="CABI Logo">
    <div class="role-switcher">
        <label for="currentUserSelect">Logged in as:</label>
        <select id="currentUserSelect">
            <!-- Options populated by JavaScript -->
        </select>
        <span id="currentRoleBadge" class="role-badge"></span>
    </div>
    <h1>CABI COSHH Helper</h1>
</div>

<div class="app-container">
    <div class="tab-header">
        <button class="tab-button" onclick="openTab(event, 'inventoryTab')">Inventory</button>
        <button class="tab-button active" onclick="openTab(event, 'msdsInputTab')">MSDS</button>
        <button class="tab-button" onclick="openTab(event, 'personnelTab')">1. Personnel</button>
        <button class="tab-button" onclick="openTab(event, 'substanceTabInternal')">2. Substance & Task</button>
        <button class="tab-button" onclick="openTab(event, 'hazardsTabInternal')">3. Hazards</button>
        <button class="tab-button" onclick="openTab(event, 'procedureTabInternal')">4. Procedure</button>
        <button class="tab-button" onclick="openTab(event, 'riskEvalTab')">5. Risk Eval</button>
        <button class="tab-button" onclick="openTab(event, 'controlsTabInternal')">6. Controls</button>
        <button class="tab-button" onclick="openTab(event, 'furtherActionsTab')">7. Actions</button>
        <button class="tab-button" onclick="openTab(event, 'ackReviewTab')">8. Acknowledge</button>
        <button class="tab-button" onclick="openTab(event, 'outputTab')">Report</button>
    </div>

    <form id="coshhFullForm">
        <!-- Chemical Inventory & Assessment Tracking -->
        <div id="inventoryTab" class="tab-pane">
            <h2>Chemical Inventory & Assessment Tracker</h2>
            <p>View your chemical inventory and track COSHH assessment status.</p>

            <div id="inventoryStats" class="inventory-stats">
                <div class="stat-card">
                    <h3>Total Chemicals</h3>
                    <span id="statTotal">-</span>
                </div>
                <div class="stat-card complete">
                    <h3>Assessments Complete</h3>
                    <span id="statComplete">-</span>
                </div>
                <div class="stat-card in-progress">
                    <h3>In Progress</h3>
                    <span id="statInProgress">-</span>
                </div>
                <div class="stat-card needs-attention">
                    <h3>Needs Assessment</h3>
                    <span id="statNeedsAssessment">-</span>
                </div>
                <div class="stat-card review-due">
                    <h3>Review Due</h3>
                    <span id="statReviewDue">-</span>
                </div>
            </div>

            <div style="margin: 20px 0;">
                <label for="inventorySearch">Search Chemicals:</label>
                <input type="text" id="inventorySearch" placeholder="Search by name, CAS number, location..." style="width: 300px;">

                <label for="inventoryFilter" style="margin-left: 20px;">Filter by Status:</label>
                <select id="inventoryFilter">
                    <option value="all">All Chemicals</option>
                    <option value="needs_assessment">Needs Assessment</option>
                    <option value="in_progress">In Progress</option>
                    <option value="complete">Complete</option>
                    <option value="review_due">Review Due</option>
                    <option value="not_required">Not Required</option>
                </select>

                <button type="button" class="secondary-button" onclick="refreshInventoryData()" style="margin-left: 20px;">üîÑ Refresh Data</button>
                <button type="button" class="action-button" onclick="openFloorPlan(1)" style="margin-left: 10px;">üó∫Ô∏è View Floor Plan</button>
            </div>

            <div id="inventoryTableContainer">
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Chemical Name</th>
                            <th>CAS Number</th>
                            <th>Location</th>
                            <th>Hazards</th>
                            <th>Assessment Status</th>
                            <th>Assessed By</th>
                            <th>Review Due</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <tr><td colspan="8" style="text-align:center; padding: 40px;">Loading inventory...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- MSDS Input & Preview (Tab 0) -->
        <div id="msdsInputTab" class="tab-pane active">
            <h2>MSDS Input & Parsing</h2>
            <p>This step helps auto-fill hazard information. You can skip or manually enter data later.</p>
            <!-- In msdsInputTab or a new "Data Management" Tab -->
            <label for="msdsFile">Upload MSDS PDF:</label>
            <input type="file" id="msdsFile" name="msdsFile" accept=".pdf">
            <button type="button" class="action-button" id="parsePdfButton">Parse Uploaded PDF</button>
            <hr style="margin: 20px 0;">
            <label for="msdsTextPaste">Or Paste MSDS Text:</label>
            <textarea id="msdsTextPaste" name="msdsTextPaste" rows="8" placeholder="Paste text from MSDS here..."></textarea>
            <button type="button" class="action-button" id="parseTextButton">Parse Pasted Text</button>
            <div id="parserStatus" style="margin-top:10px;"></div>
            <hr style="margin: 20px 0;">
            <h4>Try an Example</h4>
            <p style="font-size:0.9em; color:#555;">Download these example files to see how the tool works:</p>
            <ul style="margin-left:20px;">
                <li><strong>Example MSDS:</strong> <a href="examples/HiDi Formamide.pdf" target="_blank" download>HiDi Formamide MSDS (PDF)</a> - Upload this in the MSDS section above</li>
                <li><strong>Example Assessment Data:</strong> <a href="examples/cabi_coshh_dynamic_2025-10-07.json" target="_blank" download>HiDi Assessment (JSON)</a> - Import this using the button below</li>
                <li><strong>Example Completed Report:</strong> <a href="examples/coshhform-hidi.pdf" target="_blank" download>HiDi COSHH Report (PDF)</a> - See what the final output looks like</li>
            </ul>
            <hr style="margin: 20px 0;">
            <h4>Manage Assessment Data</h4>
            <label for="importFile">Import COSHH Assessment (JSON file):</label>
            <input type="file" id="importFile" name="importFile" accept=".json">
            <button type="button" class="secondary-button" id="importJsonButton">Import from JSON File</button>
            <div id="msdsPreviewPane" style="display:none;">
                <h3>MSDS Parse Preview & Confirmation</h3>
                <p>Review extracted data. Edit if necessary. Parsed data will auto-fill relevant form fields.</p>
                <table id="parsePreviewTable">
                    <thead><tr><th>Field</th><th>Extracted Value(s)</th><th>Confidence</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="action-button" id="applyParsedDataButton">Apply Parsed Data & Proceed to Form</button>
            </div>
        </div>

        <!-- Tab 1: Personnel Details -->
        <div id="personnelTab" class="tab-pane">
            <h3>Step 1 (Part A): Personnel & Assessment Details</h3>
            <!-- Role-based indicator (Phase 5: Plan 02) -->
            <div id="personnelRoleIndicator" class="role-indicator"></div>
            <div id="personnelPermissionWarning" class="permission-warning hidden-for-role"></div>
            <div class="form-section">
                <h4>Assessment Details</h4>
                <div class="column-layout">
                    <div class="column"><label for="carriedOutBy">Carried Out By (Step 1):</label><input type="text" id="carriedOutBy" name="carriedOutBy"></div>
                    <div class="column"><label for="department">Department:</label><input type="text" id="department" name="department"></div>
                </div>
                <div class="column-layout">
                    <div class="column"><label for="ref">Ref:</label><input type="text" id="ref" name="ref"></div>
                    <div class="column"><label for="signatureCarriedOut">Signature (Type Name):</label><input type="text" id="signatureCarriedOut" name="signatureCarriedOut"></div>
                    <div class="column"><label for="dateCarriedOut">Date:</label><input type="date" id="dateCarriedOut" name="dateCarriedOut"></div>
                </div>
                <!-- Assignment to COSHH Assessor (Phase 5: Plan 03) -->
                <div class="column-layout" style="margin-top: 15px;">
                    <div class="column">
                        <label for="assignedToAssessor">Assign to COSHH Assessor:</label>
                        <select id="assignedToAssessor" name="assignedToAssessor">
                            <option value="">-- Not yet assigned --</option>
                            <!-- Options populated by JavaScript from mockUsers (assessors and admins) -->
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab 2: Substance & Task Overview -->
        <div id="substanceTabInternal" class="tab-pane">
            <h3>Step 1 (Part B): Substance & Task Overview</h3>
             <div class="form-section">
                <h4>Substance Identification</h4>
                <label for="chemicalName">Chemical Name (Product Name from MSDS): <span id="chemicalNameConfidence" class="confidence-marker"></span></label>
                <input type="text" id="chemicalName" name="chemicalName" placeholder="Auto-filled from MSDS or enter manually">
                <div class="column-layout">
                    <div class="column"><label for="casNumber">CAS Number: <span id="casNumberConfidence" class="confidence-marker"></span></label><input type="text" id="casNumber" name="casNumber" placeholder="Auto-filled from MSDS"></div>
                    <div class="column"><label for="supplier">Supplier:</label><input type="text" id="supplier" name="supplier"></div>
                </div>
            </div>
            <div class="form-section">
                <h4>Task & Process</h4>
                <label for="activityDescription">Describe the activity or work process, product(s) and location:</label>
                <textarea id="activityDescription" name="activityDescription" rows="3" placeholder="Will be partly auto-filled by Procedure selection"></textarea>
                <label class="label-header">Identify who is exposed:</label>
                <div class="checkbox-inline">
                    <label><input type="checkbox" name="whoExposed" value="Employees" checked> Employees</label>
                    <label><input type="checkbox" name="whoExposed" value="Contractors"> Contractors</label>
                    <label><input type="checkbox" name="whoExposed" value="Others"> Others e.g. visitors</label>
                </div>
                <label for="materialTypeForm">What type of material is used? <span class="editable-note">(Influences Physical Characteristics)</span></label>
                <select id="materialTypeForm" name="materialTypeForm">
                    <option value="liquid_volatile">Liquid - Volatile</option>
                    <option value="liquid_nonvolatile">Liquid - Non-Volatile</option>
                    <option value="solid_powder_dusty">Solid - Powder/Dusty</option>
                    <option value="solid_pellet_granule">Solid - Pellet/Granule (Low dust)</option>
                    <option value="gas_direct_use">Gas (Direct use/piped)</option>
                    <option value="gas_cylinder_handling">Gas (Cylinder handling)</option>
                    <option value="aerosol_generated">Aerosol (Generated by process)</option>
                </select>
                 <div class="checkbox-inline" style="margin-top:10px;"><label><input type="checkbox" id="msdsAttached" name="msdsAttached" value="on"> MSDS attached to this assessment?</label></div>
            </div>
        </div>

        <!-- Tab 3: Hazard Details (from Form/MSDS) -->
        <div id="hazardsTabInternal" class="tab-pane">
             <h3>Step 1 (Part C): Hazard Identification</h3>
             <div class="form-section">
                <label class="label-header">What are the hazards? (New Symbols - tick all that apply) <span id="pictogramsConfidence" class="confidence-marker"></span></label>
                <div class="checkbox-inline" style="display:flex; flex-wrap:wrap; gap:10px;">
                    <label title="GHS07: Harmful / Irritant"><input type="checkbox" name="ghsPictogram" value="GHS07_HarmfulIrritant"> <img src="./ghs_exclam.svg" alt="Exclamation Mark" style="height:20px; vertical-align:middle;"> Harmful/Irritant</label>
                    <label title="GHS09: Hazardous to the Environment"><input type="checkbox" name="ghsPictogram" value="GHS09_Environment"> <img src="./ghs_environment.svg" alt="Environment" style="height:20px; vertical-align:middle;"> Environment</label>
                    <label title="GHS06: Toxic / Very Toxic"><input type="checkbox" name="ghsPictogram" value="GHS06_Toxic"> <img src="./ghs_skull.svg" alt="Skull" style="height:20px; vertical-align:middle;"> Toxic/Very Toxic</label>
                    <label title="GHS05: Corrosive"><input type="checkbox" name="ghsPictogram" value="GHS05_Corrosive"> <img src="./ghs_corrosive.svg" alt="Corrosive" style="height:20px; vertical-align:middle;"> Corrosive</label>
                    <label title="GHS02: Flammable / Highly or Extremely Flammable"><input type="checkbox" name="ghsPictogram" value="GHS02_Flammable"> <img src="./ghs_flammable.svg" alt="Flammable" style="height:20px; vertical-align:middle;"> Flammable</label>
                    <label title="GHS03: Oxidising"><input type="checkbox" name="ghsPictogram" value="GHS03_Oxidising"> <img src="./ghs_oxidising.svg" alt="Oxidising" style="height:20px; vertical-align:middle;"> Oxidising</label>
                    <label title="GHS01: Explosive"><input type="checkbox" name="ghsPictogram" value="GHS01_Explosive"> <img src="./ghs_explosive.svg" alt="Explosive" style="height:20px; vertical-align:middle;"> Explosive</label>
                    <label title="GHS08: Health Hazard (Carcinogen/Mutagen/Reproductive Toxin/Sensitiser/STOT/Aspiration)"><input type="checkbox" name="ghsPictogram" value="GHS08_HealthHazard"> <img src="./ghs_health_hazard.svg" alt="Health Hazard" style="height:20px; vertical-align:middle;"> Health Hazard</label>
                    <label title="GHS04: Gas Under Pressure"><input type="checkbox" name="ghsPictogram" value="GHS04_GasPressure"> <img src="./ghs_gas_cylinder.svg" alt="Gas Cylinder" style="height:20px; vertical-align:middle;"> Gas Under Pressure</label>
                </div>
                <input type="hidden" id="parsedRawPictograms" name="parsedRawPictograms"> 

                <label for="hPhrasesForm">H (Hazard) statements (from MSDS): <span id="hPhrasesConfidence" class="confidence-marker"></span> <span class="editable-note">(Influences Hazard Group)</span></label>
                <textarea id="hPhrasesForm" name="hPhrasesForm" rows="3" placeholder="e.g., H302, H330 - Auto-filled from MSDS if parsed. Add exposure type if known e.g. (contact), (inhalation)"></textarea>
            </div>
            <div class="form-section">
                <label class="label-header">Workplace Exposure Levels (WEL) (if assigned)</label>
                <p style="font-size: 0.9em; margin: 5px 0;">
                    Reference: <a href="https://www.hse.gov.uk/pubns/priced/eh40.pdf" target="_blank" rel="noopener">HSE EH40 Workplace Exposure Limits</a>
                    <button type="button" onclick="autoFillWELValues()" style="margin-left: 10px; font-size: 0.85em; padding: 3px 8px;">üîç Lookup WEL</button>
                    <span id="welMatchStatus" style="margin-left: 10px; font-style: italic;"></span>
                </p>
                <div class="column-layout">
                    <div class="column"><label for="stelPPM">STEL (ppm):</label><input type="text" id="stelPPM" name="stelPPM"></div>
                    <div class="column"><label for="stelMgM3">STEL (mg/m¬≥):</label><input type="text" id="stelMgM3" name="stelMgM3"></div>
                </div>
                <div class="column-layout">
                    <div class="column"><label for="twaPPM">TWA (ppm):</label><input type="text" id="twaPPM" name="twaPPM"></div>
                    <div class="column"><label for="twaMgM3">TWA (mg/m¬≥):</label><input type="text" id="twaMgM3" name="twaMgM3"></div>
                </div>
            </div>
        </div>
        
        <!-- Tab 4: Procedure Details -->
        <div id="procedureTabInternal" class="tab-pane">
            <h3>Step 1 (Part D): Procedure Details & Exposure Factors</h3>
            <div class="form-section">
                <label for="labProcedure">Common Lab Procedure: <span class="editable-note">(Influences Task Desc, Quantity Group, Exposure Routes, Risk)</span></label>
                <select id="labProcedure" name="labProcedure">
                    <option value="">--Select or describe manually--</option>
                    <option value="pipetting_micro">Pipetting (Microlitres, e.g. <1mL)</option>
                    <option value="pipetting_small">Pipetting (Small Vol, e.g. 1-50mL)</option>
                    <option value="pipetting_large">Pipetting (Larger Vol, e.g. >50mL)</option>
                    <option value="decanting_small">Decanting Liquids (Small Scale)</option>
                    <option value="decanting_large">Decanting Liquids (Large Scale)</option>
                    <option value="weighing_solid_trace">Weighing Solids (Trace/mg, Enclosed Balance)</option>
                    <option value="weighing_solid_small_enclosed">Weighing Solids (g, Enclosed Balance)</option>
                    <option value="weighing_solid_open">Weighing Solids (Open Bench - potential dust)</option>
                    <option value="mixing_stirring_closed">Mixing/Stirring (Closed Vessel)</option>
                    <option value="mixing_stirring_open">Mixing/Stirring (Open Vessel)</option>
                    <option value="vortexing_closed">Vortexing (Capped Tube)</option>
                    <option value="vortexing_open">Vortexing (Open Tube - aerosol risk)</option>
                    <option value="centrifuging_sealed">Centrifuging (Sealed Rotors/Tubes)</option>
                    <option value="centrifuging_unsealed">Centrifuging (Unsealed - aerosol risk)</option>
                    <option value="heating_reflux_closed">Heating/Reflux (Closed System)</option>
                    <option value="heating_open_beaker">Heating (Open Beaker)</option>
                    <option value="surface_wiping_small">Surface Wiping (Small Area)</option>
                    <option value="surface_wiping_large">Surface Wiping (Large Area)</option>
                    <option value="other_manual">Other (Describe Manually)</option>
                </select>
            </div>
            <div class="form-section">
                <label for="quantityValue">Approximate Quantity Used per Task: <span class="editable-note">(Influences Quantity Group)</span></label>
                <div class="column-layout">
                    <div class="column"><input type="number" id="quantityValue" name="quantityValue" placeholder="e.g., 10, 500"></div>
                    <div class="column">
                        <select id="quantityUnit" name="quantityUnit">
                            <option value="¬µL">¬µL</option> <option value="mL" selected>mL</option> <option value="L">L</option>
                            <option value="¬µg">¬µg</option> <option value="mg">mg</option> <option value="g">g</option> <option value="kg">kg</option>
                        </select>
                    </div>
                </div>
                <label for="concentration">Concentration (if applicable):</label>
                <input type="text" id="concentration" name="concentration" placeholder="e.g., 70%, Neat, 0.1M">
                <label for="taskFrequency">Frequency of Task: <span class="editable-note">(Influences Likelihood)</span></label>
                <select id="taskFrequency" name="taskFrequency">
                    <option value="rarely">Rarely/Annually (<1/month)</option>
                    <option value="monthly">Monthly (1-4 times/month)</option>
                    <option value="weekly" selected>Weekly (1-4 times/week)</option>
                    <option value="daily">Daily (Once per day)</option>
                    <option value="multiple_daily">Multiple times per day</option>
                </select>
                 <label for="taskDuration">Typical Duration of Exposure per Task: <span class="editable-note">(Influences Likelihood)</span></label>
                <select id="taskDuration" name="taskDuration">
                    <option value="short">< 15 minutes</option>
                    <option value="medium" selected>15 - 60 minutes</option>
                    <option value="long">1 - 4 hours</option>
                    <option value="very_long">> 4 hours (full shift)</option>
                </select>
            </div>
            <div class="form-section">
                <label class="label-header">Anticipated Routes of Exposure: <span class="editable-note">(Auto-suggested by procedure, confirm/edit)</span></label>
                <div id="routesOfExposureCheckboxes" class="checkbox-inline">
                    <label><input type="checkbox" name="exposureRoute" value="Inhalation"> Inhalation</label>
                    <label><input type="checkbox" name="exposureRoute" value="SkinContact"> Skin Contact</label>
                    <label><input type="checkbox" name="exposureRoute" value="EyeContact"> Eye Contact</label>
                    <label><input type="checkbox" name="exposureRoute" value="Ingestion"> Ingestion (accidental)</label>
                </div>
            </div>
        </div>

        <!-- Tab 5: Risk Assessment Evaluation (Dynamic) -->
        <div id="riskEvalTab" class="tab-pane">
            <h3>Step 2: The Risk Assessment Evaluation <span class="editable-note">(Auto-populated, review & override if needed)</span></h3>
            <p style="font-size:0.9em; color:#555;">Internal Risk Score (for logic): Severity <span id="calculatedSeverityScore">0</span> x Likelihood <span id="calculatedLikelihoodScore">0</span> = Total <span id="calculatedTotalRiskScore">0</span></p>
            <table class="risk-matrix-table">
                 <thead><tr><th>Factor</th><th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>S (Specialist)</th></tr></thead>
                <tbody>
                    <tr>
                        <td>Hazard Group <span class="editable-note">(from H-phrases)</span></td>
                        <td><label><input type="radio" name="hazardGroup" value="A"> A</label></td>
                        <td><label><input type="radio" name="hazardGroup" value="B"> B</label></td>
                        <td><label><input type="radio" name="hazardGroup" value="C"> C</label></td>
                        <td><label><input type="radio" name="hazardGroup" value="D"> D</label></td>
                        <td><label><input type="radio" name="hazardGroup" value="E"> E</label></td>
                        <td><label><input type="radio" name="hazardGroup" value="S"> S</label></td>
                    </tr>
                    <tr>
                        <td>Quantity / Volume Group <span class="editable-note">(from Procedure/Qty)</span></td>
                        <td colspan="2" style="text-align:center;"><label><input type="radio" name="quantityGroup" value="Small"> Small</label></td>
                        <td colspan="2" style="text-align:center;"><label><input type="radio" name="quantityGroup" value="Medium"> Medium</label></td>
                        <td colspan="2" style="text-align:center;"><label><input type="radio" name="quantityGroup" value="Large"> Large</label></td>
                    </tr>
                    <tr>
                        <td>Physical Characteristics Group <span class="editable-note">(from Material Type/Volatility)</span></td>
                        <td colspan="2" style="text-align:center;"><label><input type="radio" name="physCharGroup" value="Low"> Low (e.g. non-volatile liquid, pellets)</label></td>
                        <td colspan="2" style="text-align:center;"><label><input type="radio" name="physCharGroup" value="Medium"> Medium (e.g. some liquids, granules)</label></td>
                        <td colspan="2" style="text-align:center;"><label><input type="radio" name="physCharGroup" value="High"> High (e.g. volatile liquid, fine dust, gas)</label></td>
                    </tr>
                    <tr>
                        <td><strong>Control Group Determined</strong> <span class="editable-note">(from Risk Assessment)</span></td>
                        <td><label><input type="radio" name="controlGroup" value="1"> 1</label></td>
                        <td><label><input type="radio" name="controlGroup" value="2"> 2</label></td>
                        <td><label><input type="radio" name="controlGroup" value="3"> 3</label></td>
                        <td><label><input type="radio" name="controlGroup" value="4"> 4</label></td>
                        <td colspan="2" style="text-align:center;"><label><input type="radio" name="controlGroup" value="S"> S (Specialist)</label></td>
                    </tr>
                </tbody>
            </table>
            <div class="form-section" style="margin-top:20px;">
                <h4>Reviewer Details (for Step 2 & 3)</h4>
                <div class="column-layout">
                    <div class="column"><label for="reviewedBy">Reviewed By (Steps 2 & 3):</label><input type="text" id="reviewedBy" name="reviewedBy"></div>
                    <div class="column"><label for="signatureReviewedBy">Signature (Type Name):</label><input type="text" id="signatureReviewedBy" name="signatureReviewedBy"></div>
                    <div class="column"><label for="dateReviewedBy">Date:</label><input type="date" id="dateReviewedBy" name="dateReviewedBy"></div>
                </div>
            </div>
        </div>

        <!-- Tab 6: Suitable Controls (Dynamic Defaults) -->
        <div id="controlsTabInternal" class="tab-pane">
            <h3>Step 3: The Suitable Controls <span class="editable-note">(Auto-suggested based on Control Group, review & override)</span></h3>
             <div class="column-layout">
                 <div class="column"><label for="approvalConfirmedBy">Approval for use confirmed by:</label><input type="text" id="approvalConfirmedBy" name="approvalConfirmedBy"></div>
                 <div class="column"><label for="approvalDate">Date:</label><input type="date" id="approvalDate" name="approvalDate"></div>
            </div>
            <button type="button" class="secondary-button" id="recalculateControlsButtonInternal">Re-calculate Control Suggestions</button>
            <div class="form-section">
                <h4>General control measures <small>(HSE Control Guidance Sheet No: <span id="gcGuidanceSheetNo">N/A</span>)</small></h4>
                <div class="checkbox-inline">
                    <label><input type="checkbox" name="generalControl" value="Ventilation100"> General Ventilation (100)</label>
                    <label><input type="checkbox" name="generalControl" value="LEV200_201"> LEV (fume cupboard) (200/201)</label>
                    <label><input type="checkbox" name="generalControl" value="Containment300_301"> Containment (glove box etc) (300/301)</label>
                    <label><input type="checkbox" name="generalControl" value="Specialist400"> Specialist Control Approaches (400)</label>
                    <label><input type="checkbox" name="generalControl" value="AdditionalS100_S200"> Additional Precautions (S100/S200)</label>
                </div>
            </div>
            <div class="form-section">
                <h4>Personal Protective Equipment <small>(HSE Control Guidance Sheet No: <span id="ppeGuidanceSheetNo">N/A</span>)</small></h4>
                <div class="checkbox-inline">
                    <label><input type="checkbox" name="ppeControl" value="Clothing100"> Protective Clothing (100)</label>
                    <label><input type="checkbox" name="ppeControl" value="Gloves200_201"> Gloves/Footwear (200/201)</label>
                    <label><input type="checkbox" name="ppeControl" value="Eye300_301"> Eye Protection (300/301)</label>
                    <label id="respiratoryPPELabel"><input type="checkbox" name="ppeControl" value="Respiratory400"> Respiratory Protection (400)</label>
                    <label><input type="checkbox" name="ppeControl" value="OtherS100_S200"> Other (S100/S200)</label>
                </div>
                <label for="ppeSpecifyType">Specify type (Gloves, Respirator etc.): <span class="editable-note">(Auto-suggested, edit as needed)</span></label>
                <textarea id="ppeSpecifyType" name="ppeSpecifyType" rows="3"></textarea>
            </div>
             <div class="form-section">
                <label for="firstAidReqs">Specific First Aid requirements? <span id="firstAidConfidence" class="confidence-marker"></span></label>
                <textarea id="firstAidReqs" name="firstAidReqs" rows="3" placeholder="Auto-filled from MSDS if parsed"></textarea>
                <label for="fireExtinguisherReqs">Particular fire extinguisher requirements? <span class="editable-note">(Auto-suggested)</span></label>
                <input type="text" id="fireExtinguisherReqs" name="fireExtinguisherReqs">
                <label for="spillReqs">Accidental Release / Spillage requirements e.g. spill kit <span id="spillageConfidence" class="confidence-marker"></span></label>
                <textarea id="spillReqs" name="spillReqs" rows="3" placeholder="Auto-filled from MSDS if parsed"></textarea>
                 <label for="storageReqs">Handling and storage requirements? Note any incompatibilities. <span id="handlingStorageConfidence" class="confidence-marker"></span></label>
                <textarea id="storageReqs" name="storageReqs" rows="3" placeholder="Auto-filled from MSDS Section 7 if parsed"></textarea>
                <label for="disposalPrecautions">Disposal precautions? Note any incompatibilities. <span id="disposalConfidence" class="confidence-marker"></span></label>
                <textarea id="disposalPrecautions" name="disposalPrecautions" rows="3" placeholder="Auto-filled from MSDS if parsed"></textarea>
                <label for="trainingNeeded">Particular Instruction and training needed on use?</label>
                <input type="text" id="trainingNeeded" name="trainingNeeded">
                <label for="symptomsToReport">Any specific symptoms to be aware of and to report?</label>
                <input type="text" id="symptomsToReport" name="symptomsToReport">
                <label for="healthSurveillance">Health Surveillance requirements?</label>
                <input type="text" id="healthSurveillance" name="healthSurveillance">
                <label for="workplaceMonitoring">Workplace and Personal Monitoring requirements?</label>
                <input type="text" id="workplaceMonitoring" name="workplaceMonitoring">
                <label for="emergencyPlans">Emergency Plans required or not?</label>
                <input type="text" id="emergencyPlans" name="emergencyPlans">
            </div>
        </div>

        <!-- Tab 7: Further Actions -->
        <div id="furtherActionsTab" class="tab-pane">
            <h3>Step 4: Further Actions or Additional Measures Required</h3>
            <table class="actions-table">
                <thead><tr><th>Actions / Measures Required</th><th>Who</th><th>When</th><th>Check</th></tr></thead>
                <tbody>
                    <tr><td><input type="text" name="action_1_measure"></td><td><input type="text" name="action_1_who"></td><td><input type="date" name="action_1_when"></td><td><input type="text" name="action_1_check"></td></tr>
                    <tr><td><input type="text" name="action_2_measure"></td><td><input type="text" name="action_2_who"></td><td><input type="date" name="action_2_when"></td><td><input type="text" name="action_2_check"></td></tr>
                    <tr><td><input type="text" name="action_3_measure"></td><td><input type="text" name="action_3_who"></td><td><input type="date" name="action_3_when"></td><td><input type="text" name="action_3_check"></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Tab 8: Acknowledgement and Review (Final) -->
        <div id="ackReviewTab" class="tab-pane">
             <h3>Step 5: Acknowledgement and Review</h3>
            <p>I declare that I have read, understood and been instructed in the measures to be applied and agree to abide by the findings.</p>
            <div class="column-layout">
                <div class="column"><label for="finalReviewerName">Name:</label><input type="text" id="finalReviewerName" name="finalReviewerName"></div>
                <div class="column"><label for="finalSignature">Signature (Type Name):</label><input type="text" id="finalSignature" name="finalSignature"></div>
            </div>
            <div class="column-layout">
                <div class="column"><label for="finalReviewDate">Review Date (Next):</label><input type="date" id="finalReviewDate" name="finalReviewDate"></div>
                 <div class="column"><label for="finalDateSigned">Date Signed:</label><input type="date" id="finalDateSigned" name="finalDateSigned"></div>
            </div>

            <!-- COSHH Assessor Approval Section (Phase 5: Plan 02) - visible to assessors/admin only -->
            <div id="assessorApprovalSection" class="assessor-only hidden-for-role" data-requires-permission="approve">
                <h4>COSHH Assessor Approval</h4>
                <label><input type="checkbox" id="assessorApproved" name="assessorApproved"> I approve this assessment as compliant</label>
                <div class="column-layout">
                    <div class="column"><label for="assessorName">Assessor Name:</label><input type="text" id="assessorName" name="assessorName"></div>
                    <div class="column"><label for="assessorApprovalDate">Approval Date:</label><input type="date" id="assessorApprovalDate" name="assessorApprovalDate"></div>
                </div>
            </div>
        </div>

        <!-- Tab 9: Output & Save (Report Generation) -->
        <div id="outputTab" class="tab-pane">
            <h2>Generated COSHH Assessment Report</h2>
            <!-- Role-based notices (Phase 5: Plan 02) -->
            <div id="outputReviewNotice" class="review-notice hidden-for-role">
                This assessment requires COSHH Assessor review before final approval.
            </div>
            <button type="button" class="action-button" id="generateReportButtonInternal">Generate/Refresh Report</button>
            <button type="button" class="secondary-button" id="saveLocalButtonInternal">Save Form Data Locally</button>
            <button type="button" class="secondary-button" id="loadLocalButtonInternal">Load Saved Data</button>
            <button type="button" class="secondary-button" id="exportJsonButtonInternal">Export Data (JSON)</button>
            <!-- Approve & Finalize button (Phase 5: Plan 02) - visible to assessors/admin only -->
            <button type="button" class="approve-button hidden-for-role" id="approveAndFinalizeButton" data-requires-permission="approve">Approve &amp; Finalize</button>
            <div id="fullReportOutput" class="output-section" style="margin-top:20px; display:none;">
                <div id="reportContent"></div>
                <button type="button" class="print-button" id="printReportButtonInternal">Print Report (or Save as PDF)</button>
            </div>
        </div>
    </form>
</div>

<div class="app-footer">
    <p>This CABI COSHH Helper application was developed by J. Miguel Bonnin with assistance from AI (Gemini and Claude) to help automate and streamline parts of the COSHH assessment process.</p>
    <p><strong>Disclaimer:</strong> This tool is designed to automate the parsing of PDF files and the initial setup of the risk matrix. The tool is intentionally cautious in its risk assessments to allow users to apply their own professional judgment and adjust controls accordingly. All generated assessments and suggestions <strong>must be thoroughly reviewed, verified, and approved by the responsible Lab Manager, COSHH Assessor, and/or other qualified safety personnel</strong> before any work commences. Users are responsible for ensuring compliance with all relevant safety regulations and local procedures.</p>
</div>

<script type="module">
    console.log("Script execution started.");

    // --- Module Imports (Phase 1: Testing Foundation) ---
    import { calculateOverallSeverity, calculateOverallLikelihood } from './js/modules/riskCalculator.js';

    // --- Module Imports (Phase 2: Runtime Safety) ---
    import { safeGetElementById, safeSetTextContent, safeSetInnerHTML, safeAddEventListener } from './js/modules/domHelpers.js';

    // --- Module Imports (Phase 4: Code Quality) ---
    import { getMasterParsedMSDSData } from './js/modules/msdsParser.js';

    // --- Module Imports (Phase 5: User Role Simulation) ---
    import { getCurrentUser, setCurrentUser, getUserById, mockUsers, ROLES, hasPermission } from './js/modules/userRoles.js';

    // Note: masterParsedMSDSData is now managed by msdsParser.js module
    // Access via window.masterParsedMSDSData or getMasterParsedMSDSData()

    // --- Configuration data loaded from external modules (Phase 2) ---
    // procedureData - loaded from js/config/procedures.js
    // hPhraseSeverityMap - loaded from js/config/hazards.js
    // hPhraseToHazardGroup - loaded from js/config/hazards.js
    // controlBandData - loaded from js/config/controls.js

    // --- Tab Navigation (must be defined before DOMContentLoaded) ---
    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-pane");
        for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; tabcontent[i].classList.remove("active"); }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) { tablinks[i].classList.remove("active"); }

        const targetTab = document.getElementById(tabName);
        if (targetTab) {
            targetTab.style.display = "block";
            targetTab.classList.add("active");
        } else { console.error("Target tab not found:", tabName); return; }

        let clickedButton = evt ? evt.currentTarget : null;
        if (!clickedButton) {
             clickedButton = Array.from(tablinks).find(btn => btn.getAttribute('onclick')?.includes(`openTab(event, '${tabName}')`));
        }
        if (clickedButton) {
            clickedButton.classList.add("active");
        } else if (tabName === 'msdsInputTab' && tablinks.length > 0) {
            tablinks[0].classList.add('active');
        }
    }

    // Expose openTab globally so onclick handlers can access it
    window.openTab = openTab;

    // --- Role Switcher Initialization (Phase 5: User Role Simulation) ---
    /**
     * Initializes the role switcher UI component
     * Populates dropdown with mock users, sets selected option, and updates badge
     */
    function initializeRoleSwitcher() {
        const userSelect = document.getElementById('currentUserSelect');
        const roleBadge = document.getElementById('currentRoleBadge');

        if (!userSelect || !roleBadge) {
            console.warn('[initializeRoleSwitcher] Role switcher elements not found');
            return;
        }

        // Populate dropdown with mock users
        userSelect.innerHTML = '';
        mockUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.name} (${ROLES[user.role].displayName})`;
            userSelect.appendChild(option);
        });

        // Set selected option to current user
        const currentUser = getCurrentUser();
        userSelect.value = currentUser.id;

        // Update role badge
        updateRoleBadge(currentUser, roleBadge);

        // Add change event listener
        userSelect.addEventListener('change', (event) => {
            const newUser = setCurrentUser(event.target.value);
            if (newUser) {
                updateRoleBadge(newUser, roleBadge);
                // Apply role-based UI updates when user switches roles (Phase 5: Plan 02)
                applyRoleBasedUI();
                console.log(`[Role Switcher] Switched to: ${newUser.name} (${ROLES[newUser.role].displayName})`);
            }
        });

        console.log(`[Role Switcher] Initialized with user: ${currentUser.name}`);
    }

    /**
     * Populates the assessor assignment dropdown with COSHH Assessors and Admins
     * Only users with 'approve' permission can be assigned (Phase 5: Plan 03)
     */
    function populateAssessorDropdown() {
        const assignedToSelect = document.getElementById('assignedToAssessor');
        if (!assignedToSelect) {
            console.warn('[populateAssessorDropdown] Assignment dropdown not found');
            return;
        }

        // Clear existing options (keep the default "Not yet assigned" option)
        assignedToSelect.innerHTML = '<option value="">-- Not yet assigned --</option>';

        // Filter users who can approve (coshh_assessor and admin roles)
        const assessors = mockUsers.filter(user => {
            const role = ROLES[user.role];
            return role && role.permissions.includes('approve');
        });

        // Add assessor options
        assessors.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.name} (${ROLES[user.role].displayName})`;
            assignedToSelect.appendChild(option);
        });

        console.log(`[populateAssessorDropdown] Populated with ${assessors.length} assessors`);
    }

    /**
     * Updates the role badge display with current user role
     * @param {Object} user - User object
     * @param {HTMLElement} badgeElement - Badge span element
     */
    function updateRoleBadge(user, badgeElement) {
        const role = ROLES[user.role];
        badgeElement.textContent = role.displayName;
        // Remove existing role classes
        badgeElement.classList.remove('lab_manager', 'coshh_assessor', 'admin');
        // Add current role class for color coding
        badgeElement.classList.add(user.role);
    }

    /**
     * Applies role-based UI visibility and indicators throughout the application
     * Called on page load and when user switches roles
     * Uses hasPermission() for flexible permission-based checks (not hard-coded role names)
     * (Phase 5: Plan 02 - Role-Based UI Visibility)
     */
    function applyRoleBasedUI() {
        const currentUser = getCurrentUser();
        const role = ROLES[currentUser.role];

        console.log(`[applyRoleBasedUI] Applying UI for: ${currentUser.name} (${role.displayName})`);

        // --- Personnel Tab Indicators ---
        const personnelRoleIndicator = document.getElementById('personnelRoleIndicator');
        const personnelPermissionWarning = document.getElementById('personnelPermissionWarning');
        const carriedOutByField = document.getElementById('carriedOutBy');

        if (personnelRoleIndicator) {
            // Build role indicator message
            let indicatorText = `You are creating this assessment as <strong>${role.displayName}</strong>`;
            if (hasPermission('review_any')) {
                indicatorText += ' <span style="color: #28a745;">(You can review any assessment)</span>';
            }
            personnelRoleIndicator.innerHTML = indicatorText;
        }

        if (personnelPermissionWarning && carriedOutByField) {
            if (!hasPermission('draft_assessment')) {
                // User cannot draft new assessments
                personnelPermissionWarning.textContent = 'Only Lab Managers can draft new assessments';
                personnelPermissionWarning.classList.remove('hidden-for-role');
                carriedOutByField.classList.add('disabled-for-role');
            } else {
                personnelPermissionWarning.classList.add('hidden-for-role');
                carriedOutByField.classList.remove('disabled-for-role');
            }
        }

        // --- Acknowledge/Review Tab - Assessor Approval Section ---
        const assessorApprovalSection = document.getElementById('assessorApprovalSection');
        if (assessorApprovalSection) {
            if (hasPermission('approve')) {
                assessorApprovalSection.classList.remove('hidden-for-role');
                // Pre-fill assessor name if blank
                const assessorNameField = document.getElementById('assessorName');
                if (assessorNameField && !assessorNameField.value) {
                    assessorNameField.value = currentUser.name;
                }
                // Set today's date for approval date if blank
                const assessorApprovalDateField = document.getElementById('assessorApprovalDate');
                if (assessorApprovalDateField && !assessorApprovalDateField.value) {
                    assessorApprovalDateField.value = new Date().toISOString().split('T')[0];
                }
            } else {
                assessorApprovalSection.classList.add('hidden-for-role');
            }
        }

        // --- Output Tab - Review Notice and Approve Button ---
        const outputReviewNotice = document.getElementById('outputReviewNotice');
        const approveAndFinalizeButton = document.getElementById('approveAndFinalizeButton');

        if (outputReviewNotice) {
            if (!hasPermission('review_any')) {
                // Lab managers see the notice that assessment needs review
                outputReviewNotice.classList.remove('hidden-for-role');
            } else {
                outputReviewNotice.classList.add('hidden-for-role');
            }
        }

        if (approveAndFinalizeButton) {
            if (hasPermission('approve')) {
                approveAndFinalizeButton.classList.remove('hidden-for-role');
            } else {
                approveAndFinalizeButton.classList.add('hidden-for-role');
            }
        }

        // --- Process all elements with data-requires-permission attribute ---
        document.querySelectorAll('[data-requires-permission]').forEach(element => {
            const requiredPermission = element.getAttribute('data-requires-permission');
            if (hasPermission(requiredPermission)) {
                element.classList.remove('hidden-for-role');
                element.classList.remove('disabled-for-role');
            } else {
                // Hide elements that require specific permissions
                element.classList.add('hidden-for-role');
            }
        });

        // --- Assignment Field Permissions (Phase 5: Plan 03) ---
        const assignedToSelect = document.getElementById('assignedToAssessor');
        if (assignedToSelect) {
            if (hasPermission('draft_assessment')) {
                // Lab managers, assessors, and admins can assign
                assignedToSelect.disabled = false;
                assignedToSelect.classList.remove('disabled-for-role');
            } else {
                // Viewers cannot change assignment
                assignedToSelect.disabled = true;
                assignedToSelect.classList.add('disabled-for-role');
            }
        }

        console.log(`[applyRoleBasedUI] UI updated successfully`);
    }

    // Expose applyRoleBasedUI globally for external access
    window.applyRoleBasedUI = applyRoleBasedUI;

    // --- Initialize Tabs & Defaults & Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded event fired.");

        // Load EH40 workplace exposure limits data
        loadEH40Data().then(success => {
            if (success) {
                console.log("EH40 data loaded successfully");
            }
        });

        if (typeof pdfjsLib !== 'undefined') {
            try {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
                console.log("pdf.js workerSrc set.");
            } catch (e) {
                console.error("Error setting pdf.js workerSrc:", e);
            }
        } else {
            console.error("pdfjsLib is not defined when trying to set workerSrc.");
        }

        openTab(null, 'msdsInputTab');
        console.log("Initial tab 'msdsInputTab' opened.");

        const today = new Date().toISOString().split('T')[0];
        ['dateCarriedOut', 'dateReviewedBy', 'approvalDate', 'finalDateSigned'].forEach(id => {
            const el = safeGetElementById(id); if (el) el.value = today;
        });
        const nextYear = new Date(); nextYear.setFullYear(nextYear.getFullYear() + 1);
        const finalReviewDateEl = safeGetElementById('finalReviewDate');
        if (finalReviewDateEl) finalReviewDateEl.value = nextYear.toISOString().split('T')[0];
        console.log("Default dates set.");

        // --- Initialize Role Switcher (Phase 5: User Role Simulation) ---
        initializeRoleSwitcher();

        // --- Populate Assessor Dropdown (Phase 5: Plan 03) ---
        populateAssessorDropdown();

        // --- Apply Role-Based UI (Phase 5: Plan 02) ---
        applyRoleBasedUI();

        safeAddEventListener('parsePdfButton', 'click', parseUploadedMSDS);
        safeAddEventListener('parseTextButton', 'click', parsePastedMSDS);
        safeAddEventListener('applyParsedDataButton', 'click', applyParsedDataToForm);

        const recalcControlsBtn = safeGetElementById('recalculateControlsButtonInternal', false) || safeGetElementById('recalculateControlsButton');
        if(recalcControlsBtn) recalcControlsBtn.addEventListener('click', updateControlSuggestions);

        const genReportBtn = safeGetElementById('generateReportButtonInternal', false) || safeGetElementById('generateReportButton');
        if(genReportBtn) genReportBtn.addEventListener('click', generateFullReport);

        const saveLocalBtn = safeGetElementById('saveLocalButtonInternal', false) || safeGetElementById('saveLocalButton');
        if(saveLocalBtn) saveLocalBtn.addEventListener('click', saveLocally);

        const loadLocalBtn = safeGetElementById('loadLocalButtonInternal', false) || safeGetElementById('loadLocalButton');
        if(loadLocalBtn) loadLocalBtn.addEventListener('click', loadLocally);

        safeAddEventListener('importJsonButton', 'click', importFromJsonFile);
        console.log("Import JSON button listener attached."); // DEBUG
        const exportJsonBtn = safeGetElementById('exportJsonButtonInternal', false) || safeGetElementById('exportJsonButton');
        if(exportJsonBtn) exportJsonBtn.addEventListener('click', exportToJson);

        const printReportBtn = safeGetElementById('printReportButtonInternal', false) || safeGetElementById('printReportButton');
        if(printReportBtn) printReportBtn.addEventListener('click', printReport);

        console.log("Main button listeners attached.");

        const labProcedureEl = safeGetElementById('labProcedure');
        if (labProcedureEl) labProcedureEl.addEventListener('change', handleProcedureChange);

        ['quantityValue', 'quantityUnit', 'taskFrequency', 'taskDuration', 'materialTypeForm', 'hPhrasesForm'].forEach(id => {
            const el = safeGetElementById(id);
            if(el) el.addEventListener('change', runFullRiskAssessmentLogic);
        });

        // Add event listeners for WEL auto-fill when chemical name or CAS changes
        const chemicalNameEl = safeGetElementById('chemicalName');
        const casNumberEl = safeGetElementById('casNumber');
        if (chemicalNameEl) {
            chemicalNameEl.addEventListener('blur', autoFillWELValues);
        }
        if (casNumberEl) {
            casNumberEl.addEventListener('blur', autoFillWELValues);
        }

        // Add assignment change listener (Phase 5: Plan 03)
        const assignedToSelect = safeGetElementById('assignedToAssessor');
        if (assignedToSelect) {
            assignedToSelect.addEventListener('change', (event) => {
                const selectedUserId = event.target.value;
                if (selectedUserId) {
                    const assignedUser = mockUsers.find(u => u.id === selectedUserId);
                    if (assignedUser) {
                        console.log(`[Assignment] Assessment will be assigned to ${assignedUser.name} for review`);
                    }
                } else {
                    console.log('[Assignment] Assessment assignment cleared');
                }
            });
        }
        document.querySelectorAll('input[name="ghsPictogram"]').forEach(cb => cb.addEventListener('change', runFullRiskAssessmentLogic));
        document.querySelectorAll('#riskEvalTab input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', updateControlSuggestions);
        });
        console.log("Dynamic input listeners attached.");
        console.log("DOMContentLoaded setup complete.");
    });

    // --- MSDS Parsing Functions ---
    // MSDS parsing functions moved to js/modules/msdsParser.js
    // Functions parseUploadedMSDS, parsePastedMSDS, processMSDSText, displayParsePreview,
    // applyParsedDataToForm, updateConfidenceMarker are now available via window.msdsParser
    // masterParsedMSDSData is now managed by the msdsParser module (accessible via window.masterParsedMSDSData)

    // --- Dynamic Logic Functions ---
    function handleProcedureChange() { /* ... (Full function from previous correct version) ... */
        console.log("handleProcedureChange called");
        const procedureKey = document.getElementById('labProcedure')?.value;
        const details = procedureData[procedureKey];
        const chemicalName = document.getElementById('chemicalName')?.value || "[Chemical Name]";
        const activityDescriptionEl = document.getElementById('activityDescription');

        if (details && activityDescriptionEl) {
            activityDescriptionEl.value = `${details.desc} with ${chemicalName}.`;
            document.querySelectorAll('input[name="exposureRoute"]').forEach(cb => cb.checked = false);
            details.routes.forEach(routeKey => {
                const cb = document.querySelector(`input[name="exposureRoute"][value="${routeKey}"]`);
                if (cb) cb.checked = true;
            });
        } else if (activityDescriptionEl) {
            activityDescriptionEl.value = `User defined procedure with ${chemicalName}.`;
        }
        runFullRiskAssessmentLogic();
    }
    function getHphrases() { /* ... (Full function from previous correct version) ... */
        const hPhrasesFormEl = document.getElementById('hPhrasesForm');
        return (hPhrasesFormEl?.value || masterParsedMSDSData.hPhrases?.value || "").toUpperCase().split(/[,;\s]+/).filter(Boolean);
    }
    function getSignalWord() { return masterParsedMSDSData.signalWord?.value || "None"; }

    /**
     * Wrapper function for calculateOverallSeverity module function
     * Reads H-phrases and signal word from DOM, then calls the pure module function
     * @returns {number} Severity score from 1-5
     */
    function calculateOverallSeverityFromDOM() {
        const hPhrases = getHphrases();
        const signalWord = getSignalWord();
        return calculateOverallSeverity(hPhrases, signalWord);
    }
    /**
     * Wrapper function for calculateOverallLikelihood module function
     * Reads procedure, quantity, frequency, and duration from DOM, then calls the pure module function
     * @returns {number} Likelihood score from 0-10
     */
    function calculateOverallLikelihoodFromDOM() {
        const procedureKey = document.getElementById('labProcedure')?.value;
        const procDetails = procedureData[procedureKey];

        const quantityValueEl = document.getElementById('quantityValue');
        const quantityValue = quantityValueEl ? parseFloat(quantityValueEl.value) || 0 : 0;

        const quantityUnitEl = document.getElementById('quantityUnit');
        const quantityUnit = quantityUnitEl ? quantityUnitEl.value : 'mL';

        const frequencyEl = document.getElementById('taskFrequency');
        const frequency = frequencyEl ? frequencyEl.value : "weekly";

        const durationEl = document.getElementById('taskDuration');
        const duration = durationEl ? durationEl.value : "medium";

        return calculateOverallLikelihood(procDetails, quantityValue, quantityUnit, frequency, duration);
    }
    /**
     * Determines hazard group from H-phrases
     * @param {string[]} hPhrases - Array of H-phrase codes
     * @returns {string} Hazard group letter (A-E or S)
     */
    function determineHazardGroup(hPhrases) {
        let determinedHazardGroup = "A";
        let maxHGSeverity = 0;

        hPhrases.forEach(phrase => {
            for (const pattern in hPhraseToHazardGroup) {
                if (phrase.startsWith(pattern) && pattern !== "default_low_sev" && pattern !== "default_no_sig_haz") {
                    const groupSeverity = {'E':5, 'S':5, 'D':4, 'C':3, 'B':2, 'A':1}[hPhraseToHazardGroup[pattern]] || 0;
                    if(groupSeverity > maxHGSeverity) {
                        determinedHazardGroup = hPhraseToHazardGroup[pattern];
                        maxHGSeverity = groupSeverity;
                    }
                }
            }
        });

        if(maxHGSeverity === 0 && hPhrases.length > 0) {
            determinedHazardGroup = hPhraseToHazardGroup["default_low_sev"];
        }
        if(hPhrases.length === 0) {
            determinedHazardGroup = hPhraseToHazardGroup["default_no_sig_haz"];
        }

        return determinedHazardGroup;
    }

    /**
     * Determines quantity category from procedure and entered quantity
     * @returns {string} Quantity category: "Small", "Medium", or "Large"
     */
    function determineQuantityCategory() {
        const procedureKey = document.getElementById('labProcedure')?.value;
        const procDetails = procedureData[procedureKey];
        let quantityCat = procDetails ? procDetails.volCat : "Medium";

        const quantityValueEl = document.getElementById('quantityValue');
        const quantityValue = quantityValueEl ? parseFloat(quantityValueEl.value) || 0 : 0;

        const quantityUnitEl = document.getElementById('quantityUnit');
        const quantityUnit = quantityUnitEl ? quantityUnitEl.value : 'mL';

        // Normalize quantity to mL/g scale
        let normalizedQuantity = quantityValue;
        if (['¬µL', '¬µg'].includes(quantityUnit)) normalizedQuantity /= 1000;
        if (['L', 'kg'].includes(quantityUnit)) normalizedQuantity *= 1000;

        // Determine category based on normalized quantity
        if (normalizedQuantity <= 10) quantityCat = "Small";
        else if (normalizedQuantity > 10 && normalizedQuantity <= 250) quantityCat = "Medium";
        else if (normalizedQuantity > 250) quantityCat = "Large";

        return quantityCat;
    }

    /**
     * Determines physical characteristics category from material type
     * @returns {string} Physical characteristics: "Low", "Medium", or "High"
     */
    function determinePhysicalCharacteristics() {
        const materialTypeEl = document.getElementById('materialTypeForm');
        const materialType = materialTypeEl ? materialTypeEl.value : "";
        let physCharCat = "Low";

        if (materialType && (materialType.includes("volatile") || materialType.includes("dusty") ||
            materialType.includes("gas_direct_use") || materialType.includes("aerosol_generated"))) {
            physCharCat = "High";
        } else if (materialType && (materialType.includes("liquid_nonvolatile") ||
            materialType.includes("solid_pellet_granule"))) {
            physCharCat = "Low";
        } else {
            physCharCat = "Medium";
        }

        return physCharCat;
    }

    /**
     * Calculates risk scores (severity, likelihood, total)
     * @returns {{severity: number, likelihood: number, total: number}} Risk scores
     */
    function calculateRiskScores() {
        const severityScore = calculateOverallSeverityFromDOM();
        const likelihoodScore = calculateOverallLikelihoodFromDOM();
        const totalRiskScore = severityScore * (likelihoodScore / 2);

        return {
            severity: severityScore,
            likelihood: likelihoodScore,
            total: totalRiskScore
        };
    }

    /**
     * Updates risk display elements in the UI
     * @param {number} severityScore - Severity score
     * @param {number} likelihoodScore - Likelihood score
     * @param {number} totalRiskScore - Total risk score
     */
    function updateRiskDisplayElements(severityScore, likelihoodScore, totalRiskScore) {
        const sevScoreEl = document.getElementById('calculatedSeverityScore');
        if(sevScoreEl) sevScoreEl.textContent = severityScore.toFixed(1);

        const likeScoreEl = document.getElementById('calculatedLikelihoodScore');
        if(likeScoreEl) likeScoreEl.textContent = likelihoodScore.toFixed(1);

        const totalScoreEl = document.getElementById('calculatedTotalRiskScore');
        if(totalScoreEl) totalScoreEl.textContent = totalRiskScore.toFixed(1);
    }

    /**
     * Determines control band from risk assessment parameters
     * @param {string} hazardGroup - Hazard group (A-E or S)
     * @param {number} severityScore - Severity score (1-5)
     * @param {number} likelihoodScore - Likelihood score (0-10)
     * @param {string[]} hPhrases - Array of H-phrase codes
     * @returns {string} Control band (1-4 or S)
     *
     * === COSHH CONTROL BANDING ALGORITHM ===
     *
     * Based on HSE COSHH Essentials control approach methodology:
     * https://www.hse.gov.uk/coshh/essentials/
     *
     * Control bands determine the level of engineering controls needed:
     *
     * BAND S (Specialist): Seek expert advice
     *   - CMR substances (H340, H350, H360 - carcinogens, mutagens, reproductive toxins)
     *   - Respiratory sensitizers (H334 - can cause occupational asthma)
     *   - Critical severity (severity ‚â•5) regardless of likelihood
     *   - These substances have special legal requirements under COSHH regulations
     *   - MUST involve a competent COSHH assessor
     *
     * BAND 3 (Containment): Full enclosure or equivalent
     *   - High severity (‚â•4) with high likelihood (‚â•5)
     *   - Example: Working with toxic volatile liquids daily
     *   - Requires: Fume cupboard, glove box, or full containment
     *
     * BAND 2 (Engineering controls): Local Exhaust Ventilation (LEV)
     *   - Moderate severity (‚â•3) with moderate likelihood (‚â•3)
     *   - OR lower severity (‚â•2) with some likelihood (‚â•2)
     *   - Example: Using irritant chemicals for routine procedures
     *   - Requires: LEV system (e.g., fume hood), engineering controls
     *
     * BAND 1 (General ventilation): Good workplace hygiene
     *   - Low severity and low likelihood
     *   - Example: Using small quantities of low-hazard chemicals infrequently
     *   - Requires: Good general ventilation, basic hygiene practices
     *
     * THRESHOLD RATIONALE:
     * The thresholds (severity ‚â•4 + likelihood ‚â•5 ‚Üí Band 3) align with the principle:
     * "Higher consequences + higher probability = stronger controls needed"
     *
     * This creates a graduated control hierarchy matching the HSE guidance where
     * controls scale with both the harm potential (severity) and exposure potential (likelihood).
     */
    function determineControlBand(hazardGroup, severityScore, likelihoodScore, hPhrases) {
        let controlBand = "1";

        // Base control band determination on severity and likelihood thresholds
        if (hazardGroup === "S" || severityScore >= 5) {
            // CMR substances or critical severity ALWAYS require specialist input
            // Legal requirement: COSHH regulation 7 for carcinogens/mutagens
            controlBand = "S";
        } else if (severityScore >= 4 && likelihoodScore >= 5) {
            // High severity + high likelihood = containment needed
            // Without containment, worker exposure is probable and consequences serious
            controlBand = "3";
        } else if (severityScore >= 3 && likelihoodScore >= 3) {
            // Moderate severity + moderate likelihood = engineering controls (LEV)
            // General ventilation insufficient for this risk level
            controlBand = "2";
        } else if (severityScore >= 2 && likelihoodScore >= 2) {
            // Lower severity but still some risk = engineering controls as precaution
            // Conservative approach: when in doubt, use LEV
            controlBand = "2";
        }

        // Override: Specific CMR or respiratory sensitizer H-phrases MUST go to specialist
        // This catches cases where hazard group determination might have been incorrect
        // or where multiple hazards combine to require specialist assessment
        if (hPhrases.some(p => ["H340", "H350", "H360", "H334"].includes(p))) {
            controlBand = "S";
        }

        return controlBand;
    }

    /**
     * Main orchestrator function for risk evaluation parameters
     * Coordinates all risk assessment sub-functions and updates the form
     */
    function determineRiskEvaluationParameters() {
        const hPhrases = getHphrases();

        // Step 1: Determine hazard group
        const hazardGroup = determineHazardGroup(hPhrases);
        setRadio("hazardGroup", hazardGroup);

        // Step 2: Determine quantity category
        const quantityCategory = determineQuantityCategory();
        setRadio("quantityGroup", quantityCategory);

        // Step 3: Determine physical characteristics
        const physicalCharacteristics = determinePhysicalCharacteristics();
        setRadio("physCharGroup", physicalCharacteristics);

        // Step 4: Calculate risk scores
        const riskScores = calculateRiskScores();
        updateRiskDisplayElements(riskScores.severity, riskScores.likelihood, riskScores.total);

        // Step 5: Determine control band
        const controlBand = determineControlBand(hazardGroup, riskScores.severity, riskScores.likelihood, hPhrases);
        setRadio("controlGroup", controlBand);
    }
    function updateControlSuggestions() { /* ... (Full, corrected function from previous response) ... */
        console.log("updateControlSuggestions called");
        const controlGroupChecked = document.querySelector('input[name="controlGroup"]:checked');
        if (!controlGroupChecked) {
            console.log("updateControlSuggestions: No control group selected.");
            return;
        }
        const controlGroup = controlGroupChecked.value;
        const guidance = controlBandData[controlGroup];
        document.querySelectorAll('input[name="generalControl"], input[name="ppeControl"]').forEach(cb => cb.checked = false);
        
        const gcSheetEl = document.getElementById('gcGuidanceSheetNo');
        const ppeSheetEl = document.getElementById('ppeGuidanceSheetNo');

        if (guidance) {
            if (gcSheetEl) gcSheetEl.textContent = guidance.general.split(/([0-9S/_]+)/).pop() || 'N/A';
            if (ppeSheetEl) ppeSheetEl.textContent = guidance.ppeSheet.split(/([0-9S/_]+)/).pop() || 'N/A';
            
            const gcCheckboxExact = document.querySelector(`input[name="generalControl"][value="${guidance.general}"]`);
            if (gcCheckboxExact) {
                gcCheckboxExact.checked = true;
            } else { 
                const gcCheckboxLEV = document.querySelector('input[name="generalControl"][value="LEV200_201"]');
                const gcCheckboxContain = document.querySelector('input[name="generalControl"][value="Containment300_301"]');

                if (guidance.general.toLowerCase().includes("lev") || guidance.general.toLowerCase().includes("200")) {
                    if (gcCheckboxLEV) gcCheckboxLEV.checked = true;
                }
                if (guidance.general.toLowerCase().includes("contain") || guidance.general.toLowerCase().includes("300")) {
                    if (gcCheckboxContain) gcCheckboxContain.checked = true;
                }
            }

            let ppeText = guidance.ppeText;

            // Check if ppeSpecifyType already has content (e.g., from imported JSON)
            const ppeSpecifyEl = document.getElementById('ppeSpecifyType');
            const existingPPEText = ppeSpecifyEl?.value || '';

            // Only regenerate PPE text if it's empty or needs updating
            if (!existingPPEText || existingPPEText === ppeText) {
                const pPhrases = masterParsedMSDSData.pPhrases?.value?.toUpperCase().split(/[,;\s]+/).filter(Boolean) || [];
                let pPhrasePPE = new Set();
                pPhrases.forEach(p => {
                    if (p.includes("P280")) pPhrasePPE.add("MSDS P280: Wear protective gloves/clothing/eye/face protection.");
                    if (p.includes("P261") || p.includes("P271")) pPhrasePPE.add("MSDS P261/P271: Avoid breathing dust/fume/gas/mist/vapours/spray. Use only outdoors or in a well-ventilated area.");
                    if (p.includes("P284") || p.includes("P285")) pPhrasePPE.add("MSDS P284/P285: Wear respiratory protection.");
                });
                if (pPhrasePPE.size > 0) ppeText += "\n\nMSDS Specific P-phrases suggest:\n" + [...pPhrasePPE].join("\n");
                if (ppeSpecifyEl) ppeSpecifyEl.value = ppeText;
            } else {
                // Use existing PPE text that was imported
                ppeText = existingPPEText;
            }
            
            const ppeGloveCb = document.querySelector('input[name="ppeControl"][value="Gloves200_201"]');
            if (ppeGloveCb && ppeText.toLowerCase().includes("glove")) ppeGloveCb.checked = true;
            
            const ppeEyeCb = document.querySelector('input[name="ppeControl"][value="Eye300_301"]');
            if (ppeEyeCb && (ppeText.toLowerCase().includes("eye") || ppeText.toLowerCase().includes("goggle") || ppeText.toLowerCase().includes("face shield"))) ppeEyeCb.checked = true;
            
            const ppeClothingCb = document.querySelector('input[name="ppeControl"][value="Clothing100"]');
            if (ppeClothingCb && (ppeText.toLowerCase().includes("clothing") || ppeText.toLowerCase().includes("lab coat") || ppeText.toLowerCase().includes("apron"))) ppeClothingCb.checked = true;
            
            const ppeRespCb = document.querySelector('input[name="ppeControl"][value="Respiratory400"]');
            if (ppeRespCb && (ppeText.toLowerCase().includes("respiratory") || ppeText.toLowerCase().includes("rpe"))) ppeRespCb.checked = true;
        }

        const hPhrases = getHphrases();
        const ghsPictogramsChecked = Array.from(document.querySelectorAll('input[name="ghsPictogram"]:checked')).map(cb => cb.value);
        const isFlammable = hPhrases.some(p => p.startsWith("H22")) || ghsPictogramsChecked.includes("GHS02_Flammable");
        const fireExtEl = document.getElementById('fireExtinguisherReqs');
        if (fireExtEl) fireExtEl.value = isFlammable ? "Ensure appropriate fire extinguisher for flammable substance is available (e.g., CO2, Dry Powder - check substance compatibility)." : "No special fire extinguisher required beyond standard lab provision, unless other flammable materials are present.";

        const respLabel = document.getElementById('respiratoryPPELabel');
        const inhalationRouteChecked = document.querySelector('input[name="exposureRoute"][value="Inhalation"]')?.checked;
        const materialTypeEl = document.getElementById('materialTypeForm');
        const materialTypeVal = materialTypeEl ? materialTypeEl.value : "";
        const isDustyVolatileAerosol = materialTypeVal.includes("volatile") || materialTypeVal.includes("dusty") || materialTypeVal.includes("aerosol") || materialTypeVal.includes("gas");
        const controlGroupVal = document.querySelector('input[name="controlGroup"]:checked')?.value;
        const requiresRPE = hPhrases.some(p => p.startsWith("H33") && !p.startsWith("H335") && !p.startsWith("H336")) || 
                            (inhalationRouteChecked && isDustyVolatileAerosol && controlGroupVal && (controlGroupVal === "2" || controlGroupVal === "3" || controlGroupVal === "4" || controlGroupVal === "S"));
        
        if (respLabel) {
            const respCheckbox = document.querySelector('input[name="ppeControl"][value="Respiratory400"]');
            if (!requiresRPE) {
                respLabel.classList.add('greyed-out');
                if(respCheckbox) respCheckbox.checked = false;
                const ppeSpecifyEl = document.getElementById('ppeSpecifyType');
                if (guidance && guidance.ppeText.toLowerCase().includes("respiratory") && ppeSpecifyEl && ppeSpecifyEl.value.includes(guidance.ppeText)) {
                     ppeSpecifyEl.value += "\n(RPE likely not required based on hazard/exposure assessment; confirm if high aerosol/dust generation.)";
                }
            } else {
                respLabel.classList.remove('greyed-out');
            }
        }

        // Auto-populate action for specialist controls (Group 4 or S)
        if (controlGroupVal === "4" || controlGroupVal === "S") {
            const action1MeasureEl = document.querySelector('input[name="action_1_measure"]');
            if (action1MeasureEl && !action1MeasureEl.value) {
                action1MeasureEl.value = "Print off physical copy of COSHH assessment to store in the lab folder";
            }
        }
    }
    function runFullRiskAssessmentLogic() { 
        console.log("runFullRiskAssessmentLogic called");
        determineRiskEvaluationParameters(); updateControlSuggestions(); 
    }
    function setRadio(name, value) { /* ... (Full function from previous correct version) ... */
        const LCaseValue = value ? String(value).toLowerCase() : "";
        const radios = document.querySelectorAll(`input[name="${name}"]`);
        radios.forEach(radio => { radio.checked = false; }); 
        let found = false;
        radios.forEach(radio => {
            if (radio.value.toLowerCase() === LCaseValue) { radio.checked = true; found = true; } 
        });
        if (!found && name === "hazardGroup" && LCaseValue === "s") { 
            const sRadio = document.querySelector(`input[name="hazardGroup"][value="S"]`); if(sRadio) sRadio.checked = true;
        }
    }
    
    // --- Report Generation (generateFullReport, printReport) ---
    // Report generation logic moved to js/modules/reportGenerator.js
    // Function generateFullReport is available via window.generateFullReport (exposed by module)
    function printReport() { window.print(); }

    // Form data management functions moved to js/modules/formManager.js
    // Functions saveLocally, loadLocally, exportToJson, importFromJsonFile, populateFormWithData
    // are now available via window.formManager or directly on window object

    console.log("Script execution finished initial setup.");
</script>
</body>
</html>